<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LearnVid AI - Saved Videos</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Montaga&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css"
    />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Costaline:wght@400&display=swap");

      /* Reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Montaga", serif;
        background: #f9f7f7;
        color: #112d4e;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        display: flex;
        height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: #112d4e;
        color: #f9f7f7;
        display: flex;
        flex-direction: column;
        border-right: 1px solid rgba(219, 226, 239, 0.1);
        transition: transform 0.3s ease;
      }

      /* Mobile Sidebar Toggle */
      .mobile-sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 998;
        backdrop-filter: blur(2px);
      }

      .mobile-sidebar-toggle {
        display: none;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        background: #112d4e;
        color: #f9f7f7;
        border: none;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .mobile-sidebar-toggle svg {
        width: 24px;
        height: 24px;
        stroke: #f9f7f7;
      }

      /* --- PERUBAHAN SIDEBAR HEADER --- */
      .sidebar-header {
        padding: 20px 16px;
        border-bottom: 1px solid rgba(219, 226, 239, 0.1);
      }
      .sidebar-logo {
        font-size: 1.25rem; /* Ukuran "LearnVid AI" */
        font-weight: 500;
        color: #f9f7f7;
        padding-left: 5px;
      }
      /* ------------------------------- */

      .sidebar-menu {
        padding: 8px 12px;
        flex: 1;
        overflow-y: auto;
      }

      .menu-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px; /* Dibuat sedikit lebih besar */
        margin-bottom: 4px; /* Jarak antar menu */
        color: #dbe2ef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        text-decoration: none; /* Ditambahkan untuk link */
      }
      .menu-item:hover {
        background: rgba(219, 226, 239, 0.1);
        color: #f9f7f7;
      }
      .menu-item.active {
        /* Style untuk link aktif */
        background: #3f72af;
        color: #f9f7f7;
      }
      .menu-item svg {
        width: 18px;
        height: 18px;
      } /* Icon sedikit lebih besar */

      .chats-section {
        margin-top: 15px;
      } /* Didekatkan */
      .chats-title {
        color: #dbe2ef;
        font-size: 11px;
        opacity: 0.7;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        padding: 0 12px;
      }

      .chat-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        margin-bottom: 2px;
        position: relative;
        color: #dbe2ef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        line-height: 1.4;
      }
      .chat-item:hover {
        background: rgba(219, 226, 239, 0.1);
      }
      .chat-item.active {
        background: #3f72af;
        color: #f9f7f7;
      }

      .chat-title {
        flex: 1;
        margin-right: 8px;
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
        vertical-align: middle;
      }

      /* ... Style .chat-menu, .sidebar-footer, .user-info, dll tetap sama ... */
      .chat-menu {
        position: relative;
      }
      .chat-menu-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        color: #666;
        display: inline-flex;
        align-items: center;
      }
      .fi-rr-file-edit {
        color: #fff;
      }
      .chat-menu-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 4px 0;
        min-width: 120px;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .chat-menu.open .chat-menu-dropdown {
        display: block;
      }
      .chat-menu-dropdown button {
        display: block;
        width: 100%;
        padding: 8px 12px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        color: #112d4e;
      }
      .chat-menu-dropdown button:hover {
        background: #f3f3f3;
      }
      .sidebar-footer {
        padding: 12px;
        border-top: 1px solid rgba(219, 226, 239, 0.1);
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.2s;
      }
      .user-info:hover {
        background: rgba(219, 226, 239, 0.1);
      }
      .user-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #3f72af;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }
      .username {
        color: #dbe2ef;
        font-size: 14px;
      }
      /* ------------------------------------------------------------------ */

      /* Main Area */
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #f9f7f7; /* Latar belakang main content */
      }

      /* Floating Review Button (dari chat.html) */
      .floating-review-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #3f72af 0%, #2d5a94 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: move;
        z-index: 9999;
        box-shadow: 0 4px 20px rgba(63, 114, 175, 0.4);
        transition: all 0.3s ease;
        border: 3px solid #f9f7f7;
        text-decoration: none;
      }
      .floating-review-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(63, 114, 175, 0.6);
      }
      .floating-review-btn:active {
        cursor: grabbing;
      }
      .floating-review-btn svg {
        width: 28px;
        height: 28px;
        color: #f9f7f7;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }
      .floating-review-btn.bounce {
        animation: bounce 2s infinite;
      }

      /* Modal (dari chat.html, diperlukan untuk sidebar) */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none; /* Diubah dari flex */
        justify-content: center;
        align-items: center;
        z-index: 999;
        backdrop-filter: blur(2px);
        animation: fadeIn 0.25s ease;
      }
      .modal {
        background: #f9f7f7;
        color: #112d4e;
        border-radius: 10px;
        padding: 24px;
        width: 90%;
        max-width: 300px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
      }
      .modal h2 {
        margin-top: 0;
        font-size: 1.2rem;
        font-weight: bold;
      }
      .modal-input {
        width: 100%;
        margin-top: 10px;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        outline: none;
        font-size: 15px;
      }
      .modal-input:focus {
        border-color: #3f72af;
        box-shadow: 0 0 0 2px rgba(63, 114, 175, 0.2);
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 18px;
        gap: 10px;
      }
      .modal-btn {
        padding: 7px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      .modal-btn.cancel {
        background: #ddd;
        color: #333;
      }
      .modal-btn.ok {
        background: #3f72af;
        color: white;
      }
      .modal-btn.ok:hover {
        background: #2b5691;
      }
      .modal-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .modal-message {
        margin: 8px 0 16px 0;
        font-size: 0.95rem;
        color: #2b3a55;
        text-align: left;
      }
      .modal-icon {
        width: 20px;
        height: 20px;
      }
      .chat-delete {
        color: #d11a2a;
        font-weight: 600;
      }
      .chat-delete:hover {
        background: #ffe5e5 !important;
        color: #a00;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          transform: translateY(15px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* ==============================================
    KODE BARU: STYLE UNTUK GALLERY
  ==============================================
  */

      .gallery-container {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
        /* Background dari Figma (biru sangat muda) */
        background: #ebf1f8;
        color: #112d4e;
      }

      .gallery-title {
        font-size: 2.5rem;
        font-weight: 500;
        margin-bottom: 30px;
        text-align: center;
        color: #112d4e;
      }

      .gallery-grid {
        display: grid;
        /* 3 kolom seperti di Figma */
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
      }

      /* Enhanced Video Card Styles */
      .video-card {
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        text-decoration: none;
        color: #112d4e;
        border-radius: 12px;
        position: relative;
        overflow: hidden;
      }

      .video-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 30px rgba(17, 45, 78, 0.15);
      }

      .video-thumbnail {
        position: relative;
        background: #222;
        border-radius: 12px;
        padding-top: 56.25%;
        overflow: hidden;
        border: 3px solid transparent;
        transition: border-color 0.3s ease;
      }

      .video-thumbnail video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.6;
        border-radius: 12px;
        transition: opacity 0.3s ease;
      }

      .video-card:hover .video-thumbnail video {
        opacity: 0.8;
      }

      .video-card:hover .video-thumbnail {
        border-color: #3f72af;
      }
      .video-card:hover .video-actions {
        opacity: 1;
        transform: translateY(0);
      }

      /* Video Info Overlay */
      .video-info {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        pointer-events: none;
        z-index: 2;
      }

      .video-card:hover .video-info {
        transform: translateY(0);
      }

      .video-title {
        color: #f9f7f7;
        font-size: 0.95rem;
        font-weight: 500;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        pointer-events: none;
        background: linear-gradient(
          to bottom,
          rgba(17, 45, 78, 0.9) 0%,
          rgba(17, 45, 78, 0.7) 70%,
          transparent 100%
        );
        padding: 12px;
        margin: -15px -15px 0 -15px; /* Negative margin to stretch to edges */
        border-radius: 12px 12px 0 0;
      }

      /* Action Buttons */
      .video-actions {
        position: absolute;
        bottom: 15px;
        left: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
        pointer-events: auto;
        z-index: 3;
      }

      .video-action-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #f9f7f7;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .video-action-btn:hover {
        transform: scale(1.1);
        background: #3f72af;
      }

      .video-action-btn:hover svg {
        stroke: #f9f7f7;
      }

      .video-action-btn svg {
        width: 18px;
        height: 18px;
        stroke: #112d4e;
        transition: stroke 0.3s ease;
      }

      .video-action-btn.fullscreen-btn svg {
        fill: none;
        stroke-width: 2;
      }

      .video-action-btn.download-btn svg {
        fill: none;
        stroke-width: 2;
      }

      /* Fullscreen Modal */
      .fullscreen-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        animation: fadeIn 0.3s ease;
      }

      .fullscreen-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .fullscreen-content {
        position: relative;
        width: 90%;
        max-width: 1200px;
        height: 80vh;
        display: flex;
        flex-direction: column;
      }

      .fullscreen-video-container {
        flex: 1;
        position: relative;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
      }

      .fullscreen-video-container video {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .fullscreen-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 20px;
        padding: 0 20px;
      }

      .fullscreen-title {
        color: #f9f7f7;
        font-size: 1.5rem;
        font-weight: 500;
      }

      .carousel-controls {
        display: flex;
        gap: 15px;
      }

      .carousel-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #3f72af;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .carousel-btn:hover {
        background: #2d5a94;
        transform: scale(1.1);
      }

      .carousel-btn svg {
        width: 24px;
        height: 24px;
        stroke: #f9f7f7;
        fill: none;
        stroke-width: 2;
      }

      .close-fullscreen-btn {
        position: absolute;
        top: -50px;
        right: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #f9f7f7;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .close-fullscreen-btn:hover {
        background: #3f72af;
        transform: rotate(90deg);
      }

      .close-fullscreen-btn svg {
        width: 20px;
        height: 20px;
        stroke: #112d4e;
      }

      .close-fullscreen-btn:hover svg {
        stroke: #f9f7f7;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .video-info {
          padding: 15px;
        }

        .video-title {
          font-size: 0.9rem;
          margin-bottom: 10px;
        }

        .video-action-btn {
          width: 32px;
          height: 32px;
        }

        .video-action-btn svg {
          width: 16px;
          height: 16px;
        }

        .fullscreen-title {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button
        class="mobile-sidebar-toggle"
        id="mobileSidebarToggle"
        aria-label="Toggle sidebar"
      >
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M3 12h18M3 6h18M3 18h18" />
        </svg>
      </button>

      <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">LearnVid AI</div>
        </div>

        <div class="sidebar-menu">
          <a href="/chat" class="menu-item">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 20v-6M6 20v-4M18 20v-2" />
              <path d="M12 14V4" />
              <path d="M6 16V4" />
              <path d="M18 18V4" />
              <path d="M3 4h18" />
            </svg>
            New Chat
          </a>

          <a href="/gallery" class="menu-item active">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
            </svg>
            Saved Videos
          </a>

          <div class="chats-section" id="chats-section">
            <div class="chats-title">Chats</div>
            {% if chats and chats|length > 0 %} {% for c in chats %}
            <div
              class="chat-item {% if loop.first and not request.query_params.get('id') %}active {% elif c.id|string == request.query_params.get('id') %}active {% endif %}"
              data-chat-id="{{ c.id }}"
            >
              <span class="chat-title">{{ c.title }}</span>
              <div class="chat-menu">
                <button class="chat-menu-btn" title="Options">
                  <i class="fi fi-rr-file-edit"></i>
                </button>
                <div class="chat-menu-dropdown">
                  <button class="chat-rename">Rename</button>
                  <button class="chat-delete">Delete</button>
                </div>
              </div>
            </div>
            {% endfor %} {% else %}
            <div id="empty-state" class="chat-item empty">No chats yet</div>
            {% endif %}
          </div>
        </div>

        <div class="sidebar-footer">
          <div class="user-info">
            <div class="user-avatar">U</div>
            <div class="username">{{username}}</div>
          </div>
        </div>
      </div>

      <div class="chat-main">
        <div class="gallery-container">
          <h1 class="gallery-title">Saved Videos</h1>

          <!-- <div class="gallery-grid" id="gallery-grid"></div> -->
          <div class="gallery-grid" id="gallery-grid">
            {% for i in range(12) %}
            <a
              href="/video/{{ i }}"
              class="video-card {% if i == 3 %}active{% endif %}"
            >
              <div class="video-thumbnail">
                <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 5v14l11-7z" />
                </svg>
              </div>
            </a>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <img id="modal-icon" class="modal-icon" alt="" />
          <h2 id="modal-title">Modal Title</h2>
        </div>
        <p id="modal-message" class="modal-message"></p>
        <input
          type="text"
          id="modal-input"
          class="modal-input"
          style="display: none"
        />
        <div class="modal-actions">
          <button id="modal-cancel" class="modal-btn cancel">Cancel</button>
          <button id="modal-ok" class="modal-btn ok">OK</button>
        </div>
      </div>
    </div>

    <script>
      // ====== User context dari Jinja ======
      const CURRENT_USERNAME = "{{ username }}";

      // ====== Elemen DOM (Sidebar) ======
      const chatsSection = document.querySelector(".chats-section");
      const sidebar = document.getElementById("sidebar");
      const mobileSidebarToggle = document.getElementById(
        "mobileSidebarToggle"
      );
      const mobileSidebarOverlay = document.getElementById(
        "mobileSidebarOverlay"
      );

      // ====== State ======
      let activeChatId = null; // Tidak ada chat yang aktif di halaman gallery

      // ====== Mobile Sidebar Toggle ======
      if (mobileSidebarToggle) {
        mobileSidebarToggle.addEventListener("click", function () {
          sidebar.classList.toggle("open");
          mobileSidebarOverlay.classList.toggle("active");
        });
      }

      if (mobileSidebarOverlay) {
        mobileSidebarOverlay.addEventListener("click", function () {
          sidebar.classList.remove("open");
          mobileSidebarOverlay.classList.remove("active");
        });
      }

      // Close sidebar when clicking a chat item on mobile
      function closeMobileSidebar() {
        if (window.innerWidth <= 768) {
          sidebar.classList.remove("open");
          mobileSidebarOverlay.classList.remove("active");
        }
      }

      function escapeHtml(str = "") {
        return str.replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }

      // ====== Event handlers (Sidebar) ======

      // Delegasi klik chat-item (arahkan ke halaman chat)
      if (chatsSection) {
        chatsSection.addEventListener("click", async function (e) {
          // Cek apakah klik pada chat item, bukan pada tombol menu
          const target = e.target.closest(".chat-item");
          if (
            !target ||
            target.classList.contains("empty") ||
            e.target.closest(".chat-menu-btn")
          ) {
            return;
          }

          const chatId = target.dataset.chatId;
          if (!chatId) return;

          // Arahkan ke halaman chat dengan ID chat yang spesifik
          // (Anda mungkin perlu menyesuaikan URL ini)
          window.location.href = `/chat?id=${chatId}`;
        });
      }

      // Chat menu: toggle, rename, delete (Fungsionalitas sidebar)
      function closeAllChatMenus(except) {
        document.querySelectorAll(".chat-menu").forEach((m) => {
          if (m !== except) m.classList.remove("open");
        });
      }

      chatsSection.addEventListener("click", (e) => {
        const btn = e.target.closest(".chat-menu-btn");
        if (!btn) return;
        e.stopPropagation();
        const menu = btn.closest(".chat-menu");
        const isOpen = menu.classList.contains("open");
        closeAllChatMenus(menu);
        if (!isOpen) menu.classList.add("open");
      });

      document.addEventListener("click", () => closeAllChatMenus(null));

      // Handler RENAME
      chatsSection.addEventListener("click", async (e) => {
        const btn = e.target.closest(".chat-rename");
        if (!btn) return;

        e.stopPropagation();
        const item = btn.closest(".chat-item");
        const chatId = item?.dataset?.chatId;
        if (!chatId) return;

        const titleSpan = item.querySelector(".chat-title");
        const currentTitle = titleSpan?.textContent?.trim() || "Untitled";

        const newTitle = await openModal({
          title: "✏️ Rename Chat",
          placeholder: "Enter new title...",
          defaultValue: currentTitle,
        });
        if (newTitle === null) return;
        const cleaned = (newTitle || "").trim();
        if (!cleaned || cleaned === currentTitle) return;

        try {
          const res = await fetch(`/api/chats/${chatId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: cleaned }),
          });
          if (!res.ok) throw new Error("Rename failed");
          const data = await res.json();

          titleSpan.textContent = data.title;
          closeAllChatMenus(null);
        } catch (err) {
          console.error(err);
          alert("Failed to rename chat");
        }
      });

      // Handler DELETE
      chatsSection.addEventListener("click", async (e) => {
        const btn = e.target.closest(".chat-delete");
        if (!btn) return;

        e.stopPropagation();
        const item = btn.closest(".chat-item");
        const chatId = item?.dataset?.chatId;
        if (!chatId) return;

        const confirmDelete = await openModal({
          title: "Delete Chat",
          message: "This action cannot be undone!",
          icon: "https://cdn-icons-png.flaticon.com/512/1214/1214428.png",
          isConfirm: true,
        });
        if (!confirmDelete) return;

        try {
          const res = await fetch(`/api/chats/${chatId}`, { method: "DELETE" });
          if (!res.ok) throw new Error("Delete failed");

          item.remove();

          if (!document.querySelector(".chat-item[data-chat-id]")) {
            const placeholder = document.createElement("div");
            placeholder.id = "empty-state";
            placeholder.className = "chat-item empty";
            placeholder.textContent = "No chats yet";
            chatsSection.appendChild(placeholder);
          }
          closeAllChatMenus(null);
        } catch (err) {
          console.error(err);
          alert("Failed to delete chat");
        }
      });

      // Draggable Floating Review Button (Global)
      const floatingBtn = document.getElementById("floatingReviewBtn");
      if (floatingBtn) {
        // (Kode draggable sama seperti di chat.html, Anda bisa copy-paste di sini)
        // ...
      }

      // Modal Helper (Diperlukan untuk sidebar)
      function openModal({
        title,
        message = "",
        icon = "",
        placeholder = "",
        defaultValue = "",
        isConfirm = false,
      }) {
        return new Promise((resolve) => {
          const overlay = document.getElementById("modal-overlay");
          const titleEl = document.getElementById("modal-title");
          // ... (sisa kode modal sama seperti di chat.html) ...

          const msgEl = document.getElementById("modal-message");
          const iconEl = document.getElementById("modal-icon");
          const inputEl = document.getElementById("modal-input");
          const okBtn = document.getElementById("modal-ok");
          const cancelBtn = document.getElementById("modal-cancel");

          titleEl.textContent = title;
          msgEl.textContent = message;
          iconEl.src = icon || "";
          iconEl.style.display = icon ? "block" : "none";
          inputEl.style.display = isConfirm ? "none" : "block";
          inputEl.placeholder = placeholder;
          inputEl.value = defaultValue;

          overlay.style.display = "flex"; // Tampilkan modal
          if (!isConfirm) inputEl.focus();

          function closeModal(value) {
            overlay.style.display = "none"; // Sembunyikan modal
            okBtn.removeEventListener("click", onOk);
            cancelBtn.removeEventListener("click", onCancel);
            inputEl.removeEventListener("keydown", onEnter);
            resolve(value);
          }

          function onOk() {
            const val = isConfirm ? true : inputEl.value.trim();
            closeModal(val || null);
          }
          function onCancel() {
            closeModal(null);
          }
          function onEnter(e) {
            if (e.key === "Enter") onOk();
          }

          okBtn.addEventListener("click", onOk);
          cancelBtn.addEventListener("click", onCancel);
          inputEl.addEventListener("keydown", onEnter);
        });
      }

      async function loadGalleryVideos() {
        const grid = document.getElementById("gallery-grid");
        grid.innerHTML =
          "<p style='color:#112D4E; text-align:center; padding:20px;'>Loading...</p>";

        try {
          const res = await fetch("/api/gallery/videos");
          const videos = await res.json();

          if (videos.length === 0) {
            grid.innerHTML = `
                <div class="empty-state" style="color:#112D4E; text-align:center; padding:20px;">
                    No videos yet.
                </div>`;
            return;
          }

          grid.innerHTML = "";

          videos.forEach((v, index) => {
            const videoUrl = v.video_url || v.url || v.path || v.file_path;
            const videoTitle = v.title || "Lorem Ipsum";

            if (!videoUrl) {
              console.warn("Video field not found for item:", v);
              return;
            }

            const card = document.createElement("div");
            card.className = "video-card";
            card.dataset.videoIndex = index;
            card.dataset.videoUrl = videoUrl;
            card.dataset.videoTitle = videoTitle;

            card.innerHTML = `
                <div class="video-thumbnail">
                    <video src="${videoUrl}" muted playsinline></video>
                    <div class="video-info">
                        <div class="video-title">${escapeHtml(videoTitle)}</div>
                        <div class="video-actions">
                            <button class="video-action-btn fullscreen-btn" title="View Fullscreen">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                                </svg>
                            </button>
                            <button class="video-action-btn download-btn" title="Download Video">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const vid = card.querySelector("video");
            vid.addEventListener("mouseenter", () => vid.play());
            vid.addEventListener("mouseleave", () => {
              vid.pause();
              vid.currentTime = 0;
            });

            grid.appendChild(card);
          });

          initializeVideoActions();
        } catch (err) {
          console.error(err);
          grid.innerHTML = `<p style="color:#d11a2a; text-align:center; padding:20px;">Failed to load videos.</p>`;
        }
      }

      // Initialize video action handlers
      function initializeVideoActions() {
        const grid = document.getElementById("gallery-grid");
        let currentVideoIndex = 0;
        let allVideos = [];

        // Collect all video data
        document.querySelectorAll(".video-card").forEach((card, index) => {
          allVideos.push({
            url: card.dataset.videoUrl,
            title: card.dataset.videoTitle,
            index: index,
          });
        });

        // Fullscreen button handler
        grid.addEventListener("click", (e) => {
          const fullscreenBtn = e.target.closest(".fullscreen-btn");
          if (!fullscreenBtn) return;

          e.preventDefault();
          e.stopPropagation();

          const card = fullscreenBtn.closest(".video-card");
          currentVideoIndex = parseInt(card.dataset.videoIndex);

          openFullscreenModal(currentVideoIndex);
        });

        // Download button handler
        grid.addEventListener("click", async (e) => {
          const downloadBtn = e.target.closest(".download-btn");
          if (!downloadBtn) return;

          e.preventDefault();
          e.stopPropagation();

          const card = downloadBtn.closest(".video-card");
          const videoUrl = card.dataset.videoUrl;
          const videoTitle = card.dataset.videoTitle;

          downloadVideo(videoUrl, videoTitle);
        });

        // Create fullscreen modal
        function openFullscreenModal(index) {
          // Remove existing modal if any
          let modal = document.getElementById("fullscreen-modal");
          if (modal) modal.remove();

          // Create new modal
          modal = document.createElement("div");
          modal.id = "fullscreen-modal";
          modal.className = "fullscreen-modal active";

          const video = allVideos[index];

          modal.innerHTML = `
            <div class="fullscreen-content">
                <button class="close-fullscreen-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
                <div class="fullscreen-video-container">
                    <video src="${video.url}" controls autoplay></video>
                </div>
                <div class="fullscreen-controls">
                    <div class="fullscreen-title">${escapeHtml(
                      video.title
                    )}</div>
                    <div class="carousel-controls">
                        <button class="carousel-btn prev-btn" ${
                          index === 0 ? "disabled" : ""
                        }>
                            <svg viewBox="0 0 24 24">
                                <polyline points="15 18 9 12 15 6"/>
                            </svg>
                        </button>
                        <button class="carousel-btn next-btn" ${
                          index === allVideos.length - 1 ? "disabled" : ""
                        }>
                            <svg viewBox="0 0 24 24">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;

          document.body.appendChild(modal);

          // Close button handler
          modal
            .querySelector(".close-fullscreen-btn")
            .addEventListener("click", () => {
              modal.classList.remove("active");
              setTimeout(() => modal.remove(), 300);
            });

          // Close on backdrop click
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.classList.remove("active");
              setTimeout(() => modal.remove(), 300);
            }
          });

          // Previous button handler
          modal.querySelector(".prev-btn").addEventListener("click", () => {
            if (index > 0) {
              currentVideoIndex = index - 1;
              modal.remove();
              openFullscreenModal(currentVideoIndex);
            }
          });

          // Next button handler
          modal.querySelector(".next-btn").addEventListener("click", () => {
            if (index < allVideos.length - 1) {
              currentVideoIndex = index + 1;
              modal.remove();
              openFullscreenModal(currentVideoIndex);
            }
          });

          // Keyboard navigation
          const keyHandler = (e) => {
            if (e.key === "Escape") {
              modal.classList.remove("active");
              setTimeout(() => modal.remove(), 300);
              document.removeEventListener("keydown", keyHandler);
            } else if (e.key === "ArrowLeft" && index > 0) {
              currentVideoIndex = index - 1;
              modal.remove();
              document.removeEventListener("keydown", keyHandler);
              openFullscreenModal(currentVideoIndex);
            } else if (e.key === "ArrowRight" && index < allVideos.length - 1) {
              currentVideoIndex = index + 1;
              modal.remove();
              document.removeEventListener("keydown", keyHandler);
              openFullscreenModal(currentVideoIndex);
            }
          };
          document.addEventListener("keydown", keyHandler);
        }

        // Download function
        async function downloadVideo(url, title) {
          try {
            const response = await fetch(url);
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = downloadUrl;
            a.download = `${title
              .replace(/[^a-z0-9]/gi, "_")
              .toLowerCase()}.mp4`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(downloadUrl);
            document.body.removeChild(a);
          } catch (error) {
            console.error("Download failed:", error);
            alert("Failed to download video");
          }
        }
      }

      // ⬅️ PANGGIL DI LUAR, BUKAN DI DALAM FUNGSI
      // loadGalleryVideos();
      // Jika dibuka tanpa server (file:/// atau localhost tanpa API)
      function loadDummyFrames() {
        const grid = document.getElementById("gallery-grid");
        grid.innerHTML = "";

        const dummyCount = 9;

        for (let i = 0; i < dummyCount; i++) {
          const card = document.createElement("div");
          card.className = "video-card";
          card.dataset.videoIndex = i;
          card.dataset.videoUrl = "#";
          card.dataset.videoTitle = "Lorem Ipsum Video " + (i + 1);

          card.innerHTML = `
            <div class="video-thumbnail">
                <div style="
                    width:100%;
                    height:100%;
                    background:#222;
                    border-radius:12px;
                    position:absolute;
                    top:0;
                    left:0;
                "></div>
                <div class="video-info">
                    <div class="video-title">Lorem Ipsum Video ${i + 1}</div>
                    <div class="video-actions">
                        <button class="video-action-btn fullscreen-btn" title="View Fullscreen">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                            </svg>
                        </button>
                        <button class="video-action-btn download-btn" title="Download Video">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        `;

          grid.appendChild(card);
        }

        initializeVideoActions();
      }

      if (location.protocol === "file:" || location.hostname === "127.0.0.1") {
        loadDummyFrames();
      } else {
        loadGalleryVideos();
      }
    </script>
  </body>
</html>
