<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LearnVid AI - Chat</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Montaga&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css"
    />
    <link rel="stylesheet" href="chat.css" />
  </head>
  <body>
    <div class="container">
      <!-- Mobile Sidebar Toggle -->
      <button
        class="mobile-sidebar-toggle"
        id="mobileSidebarToggle"
        aria-label="Toggle sidebar"
      >
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M3 12h18M3 6h18M3 18h18" />
        </svg>
      </button>

      <!-- Mobile Sidebar Overlay -->
      <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <button class="new-chat-btn" id="new-chat-btn">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <path d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            New chat
          </button>
        </div>

        <div class="sidebar-menu">
          <div class="menu-item search-row">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <path
                d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
              />
            </svg>
            <input
              id="chat-search"
              class="search-input"
              type="text"
              placeholder="Search chats..."
              autocomplete="off"
            />
            <button
              id="chat-search-clear"
              class="search-clear"
              aria-label="Clear"
            >
              âœ•
            </button>
          </div>

          <div class="menu-item">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
            </svg>
            Library
          </div>

          <div class="chats-section" id="chats-section">
            <div class="chats-title">Your Chats</div>
            {% if chats and chats|length > 0 %} {% for c in chats %}
            <div
              class="chat-item{% if loop.first %} active{% endif %}"
              data-chat-id="{{ c.id }}"
            >
              <span class="chat-title">{{ c.title }}</span>
              <div class="chat-menu">
                <button class="chat-menu-btn" title="Options">
                  <i class="fi fi-rr-file-edit"></i>
                </button>
                <div class="chat-menu-dropdown">
                  <button class="chat-rename">Rename</button>
                  <button class="chat-delete">Delete</button>
                </div>
              </div>
            </div>
            {% endfor %} {% else %}
            <div id="empty-state" class="chat-item empty">No chats yet</div>
            {% endif %}
          </div>
        </div>

        <div class="sidebar-footer">
          <div class="user-info">
            <div class="user-avatar">U</div>
            <div class="username">{{username}}</div>
          </div>
        </div>
      </div>

      <!-- Main Chat Area -->
      <div class="chat-main">
        <div class="chat-header">
          <div class="chat-title">LearnVid AI</div>
          <div class="chat-actions">
            <a href="/logout" class="action-btn">Log out</a>
          </div>
        </div>

        <div class="chat-container">
          <!-- Welcome Screen -->
          <div class="welcome-screen" id="welcome-screen">
            <h1 class="welcome-title">Welcome, {{username}}!</h1>
            <p class="welcome-subtitle">What should we learn today?</p>
          </div>

          <!-- Chat Messages -->
          <div class="chat-messages" id="chat-messages">
            <!-- Messages will be dynamically added here -->
          </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
          <div class="input-container">
            <div class="upload-btn" id="upload-btn" title="Buat Video">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <polygon points="23 7 16 12 23 17 23 7" />
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
              </svg>
            </div>

            <textarea
              class="message-input"
              id="message-input"
              placeholder="Ask anything"
              rows="1"
            ></textarea>

            <button class="send-button" id="send-button" disabled>
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path d="M22 2L11 13" />
                <path d="M22 2l-7 20-4-9-9-4 20-7z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="image-upload" class="file-input" accept="image/*" />
    <input
      type="file"
      id="document-upload"
      class="file-input"
      accept=".pdf,.doc,.docx,.txt"
    />
    <input type="file" id="video-upload" class="file-input" accept="video/*" />

    <!-- Modal -->
    <div id="modal-overlay" class="modal-overlay" style="display: none">
      <div class="modal">
        <div class="modal-header">
          <img id="modal-icon" class="modal-icon" alt="" />
          <h2 id="modal-title">Modal Title</h2>
        </div>
        <p id="modal-message" class="modal-message"></p>
        <input
          type="text"
          id="modal-input"
          class="modal-input"
          style="display: none"
        />
        <div class="modal-actions">
          <button id="modal-cancel" class="modal-btn cancel">Cancel</button>
          <button id="modal-ok" class="modal-btn ok">OK</button>
        </div>
      </div>
    </div>

    <script>
      // ====== User context dari Jinja ======
      const CURRENT_USERNAME = "{{ username }}";

      // ====== Elemen DOM ======
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const chatMessages = document.getElementById("chat-messages");
      const welcomeScreen = document.getElementById("welcome-screen");
      const newChatBtn = document.getElementById("new-chat-btn");
      const uploadBtn = document.getElementById("upload-btn");
      const chatsSection = document.querySelector(".chats-section");
      const sidebar = document.getElementById("sidebar");
      const mobileSidebarToggle = document.getElementById(
        "mobileSidebarToggle"
      );
      const mobileSidebarOverlay = document.getElementById(
        "mobileSidebarOverlay"
      );

      // File inputs (opsional)
      const imageUpload = document.getElementById("image-upload");
      const documentUpload = document.getElementById("document-upload");
      const videoUpload = document.getElementById("video-upload");

      // ====== State ======
      let chatStarted = false;
      let activeChatId = (() => {
        const firstActive = document.querySelector(".chat-item.active");
        return firstActive ? firstActive.dataset.chatId || null : null;
      })();
      let videoMode = false;

      // ====== Mobile Sidebar Toggle ======
      if (mobileSidebarToggle) {
        mobileSidebarToggle.addEventListener("click", function () {
          sidebar.classList.toggle("open");
          mobileSidebarOverlay.classList.toggle("active");
        });
      }

      if (mobileSidebarOverlay) {
        mobileSidebarOverlay.addEventListener("click", function () {
          sidebar.classList.remove("open");
          mobileSidebarOverlay.classList.remove("active");
        });
      }

      // Close sidebar when clicking a chat item on mobile
      function closeMobileSidebar() {
        if (window.innerWidth <= 768) {
          sidebar.classList.remove("open");
          mobileSidebarOverlay.classList.remove("active");
        }
      }

      // === Popup Helper ===
      function showPopup(message, type = "info") {
        const popup = document.createElement("div");
        popup.textContent = message;
        popup.className = `popup ${type}`;
        Object.assign(popup.style, {
          position: "fixed",
          bottom: "30px",
          right: "30px",
          background:
            type === "info"
              ? "#3f72af"
              : type === "success"
              ? "#3f72af"
              : "#112D4E",
          color: "white",
          padding: "12px 16px",
          borderRadius: "8px",
          boxShadow: "0 3px 8px rgba(0,0,0,0.3)",
          fontSize: "14px",
          zIndex: 9999,
          opacity: "0",
          transition: "opacity 0.3s ease, transform 0.3s ease",
          transform: "translateY(10px)",
        });

        document.body.appendChild(popup);
        setTimeout(() => {
          popup.style.opacity = "1";
          popup.style.transform = "translateY(0)";
        }, 50);

        setTimeout(() => {
          popup.style.opacity = "0";
          popup.style.transform = "translateY(10px)";
          setTimeout(() => popup.remove(), 300);
        }, 1500);
      }

      // ====== Loading Animation Functions ======
      function showLoadingMessage(type = 'thinking') {
        // Remove any existing loading indicator first
        removeLoadingMessage();
        
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message ai';
        loadingDiv.id = 'loading-indicator';
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = 'AI';
        
        const content = document.createElement('div');
        content.className = 'message-content loading-content';
        
        if (type === 'thinking') {
          content.innerHTML = `
            <div class="loader"></div>
            <span class="loading-text">Thinking...</span>
          `;
        } else if (type === 'video') {
          content.innerHTML = `
            <div class="loader"></div>
            <div class="video-loading">
              <span class="loading-text">ðŸŽ¬ Generating video...</span>
              <div class="video-progress-bar">
                <div class="video-progress-fill"></div>
              </div>
            </div>
          `;
        }
        
        loadingDiv.appendChild(avatar);
        loadingDiv.appendChild(content);
        chatMessages.appendChild(loadingDiv);
        
        chatMessages.scrollTo({
          top: chatMessages.scrollHeight,
          behavior: 'smooth'
        });
      }

      function removeLoadingMessage() {
        const loading = document.getElementById('loading-indicator');
        if (loading) loading.remove();
      }

      // ====== Helpers UI ======
      function showChatUI() {
        welcomeScreen.classList.add("hidden");
        chatMessages.style.display = "block";
        chatStarted = true;
      }

      function resetInput() {
        messageInput.value = "";
        messageInput.style.height = "auto";
        sendButton.disabled = true;
      }

      function addMessage(text, sender, videoUrl = null) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = sender === "ai" ? "AI" : "U";

        const content = document.createElement("div");
        content.className = "message-content";
        content.innerHTML = text;

        if (videoUrl) {
          const videoContainer = document.createElement("div");
          videoContainer.style.display = "flex";
          videoContainer.style.flexDirection = "column";
          videoContainer.style.alignItems = "flex-start";
          videoContainer.style.marginTop = "10px";

          const video = document.createElement("video");
          video.controls = true;
          video.src = videoUrl;
          video.style.maxWidth = "100%";
          video.style.borderRadius = "10px";

          const fileName =
            videoUrl.split("/").pop() || `EduGen_${Date.now()}.mp4`;

          const downloadBtn = document.createElement("button");
          downloadBtn.textContent = "â¬‡ï¸ Download Video";
          downloadBtn.style.marginTop = "6px";
          downloadBtn.style.fontSize = "13px";
          downloadBtn.style.color = "#DBE2EF";
          downloadBtn.style.background = "#112D4E";
          downloadBtn.style.padding = "6px 10px";
          downloadBtn.style.border = "none";
          downloadBtn.style.borderRadius = "6px";
          downloadBtn.style.cursor = "pointer";
          downloadBtn.style.fontWeight = "bold";

          downloadBtn.onclick = async () => {
            try {
              const response = await fetch(videoUrl);
              const blob = await response.blob();
              const blobUrl = URL.createObjectURL(blob);

              const a = document.createElement("a");
              a.href = blobUrl;
              a.download = fileName;
              document.body.appendChild(a);
              a.click();
              a.remove();

              URL.revokeObjectURL(blobUrl);
            } catch (err) {
              alert("âŒ Gagal mengunduh video.");
              console.error("Download error:", err);
            }
          };

          videoContainer.appendChild(video);
          videoContainer.appendChild(downloadBtn);
          content.appendChild(videoContainer);
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(content);

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTo({
          top: chatMessages.scrollHeight,
          behavior: "smooth",
        });
      }

      function ensureNotEmptyState() {
        const emptyState =
          document.getElementById("empty-state") ||
          document.querySelector(".chat-item.empty");
        if (emptyState) emptyState.remove();
      }

      function setActiveChatItemById(chatId) {
        document
          .querySelectorAll(".chat-item")
          .forEach((i) => i.classList.remove("active"));
        const node = document.querySelector(
          `.chat-item[data-chat-id="${chatId}"]`
        );
        if (node) node.classList.add("active");
      }

      function escapeHtml(str = "") {
        return str.replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }

      // ====== API calls ======
      async function createChat(title) {
        const res = await fetch("/api/chats", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: CURRENT_USERNAME, title }),
        });
        if (!res.ok) throw new Error("Failed to create chat");
        return res.json();
      }

      async function loadMessages(chatId) {
        const res = await fetch(
          `/api/chats/${chatId}/messages?username=${encodeURIComponent(
            CURRENT_USERNAME
          )}`
        );
        if (!res.ok) throw new Error("Failed to load messages");
        const data = await res.json();

        setTimeout(() => {
          chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: "smooth",
          });
        }, 200);

        return data;
      }

      async function refreshMessages(chatId) {
        try {
          const msgs = await loadMessages(chatId);
          chatMessages.innerHTML = "";
          msgs.forEach((m) => addMessage(m.content, m.role, m.video_url));
        } catch (e) {
          console.warn("refreshMessages error:", e);
        }
      }

      async function postMessage(chatId, content) {
        const res = await fetch(`/api/chats/${chatId}/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content }),
        });
        if (!res.ok) throw new Error("Failed to send message");
        return res.json();
      }

      // ====== Event handlers ======
      messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
        sendButton.disabled = !this.value.trim();
      });

      // New chat
      if (newChatBtn) {
        newChatBtn.addEventListener("click", async function (e) {
          e.preventDefault();
          try {
            const title = await openModal({
              title: "ðŸ’¬ New Chat",
              placeholder: "Enter chat title...",
              defaultValue: "New chat",
            });
            if (title === null) return;

            const chat = await createChat(
              (title || "New chat").trim() || "New chat"
            );
            activeChatId = chat.id;

            ensureNotEmptyState();
            document
              .querySelectorAll(".chat-item")
              .forEach((i) => i.classList.remove("active"));

            const node = document.createElement("div");
            node.className = "chat-item active";
            node.dataset.chatId = chat.id;
            node.innerHTML = `
          <span class="chat-title">${escapeHtml(chat.title)}</span>
          <div class="chat-menu">
            <button class="chat-menu-btn" title="Options"><i class="fi fi-rr-file-edit"></i></button>
            <div class="chat-menu-dropdown">
              <button class="chat-rename">Rename</button>
              <button class="chat-delete">Delete</button>
            </div>
          </div>
        `;

            chatsSection.appendChild(node);
            chatMessages.innerHTML = "";
            showChatUI();
            closeMobileSidebar();
          } catch (err) {
            console.error(err);
            alert("Failed to create chat");
          }
        });
      }

      // Delegasi klik chat-item
      if (chatsSection) {
        chatsSection.addEventListener("click", async function (e) {
          const target = e.target.closest(".chat-item");
          if (!target || target.classList.contains("empty")) return;

          try {
            const chatId = target.dataset.chatId;
            if (!chatId) return;

            document
              .querySelectorAll(".chat-item")
              .forEach((i) => i.classList.remove("active"));
            target.classList.add("active");
            activeChatId = chatId;

            const msgs = await loadMessages(chatId);
            ensureNotEmptyState();
            chatMessages.innerHTML = "";
            showChatUI();
            msgs.forEach((m) => addMessage(m.content, m.role, m.video_url));
            closeMobileSidebar();
          } catch (err) {
            console.error(err);
            alert("Failed to load messages");
          }
        });
      }

      // Kirim pesan
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        try {
          if (!activeChatId) {
            const chat = await createChat("New chat");
            activeChatId = chat.id;

            ensureNotEmptyState();
            const node = document.createElement("div");
            node.className = "chat-item active";
            node.dataset.chatId = chat.id;
            node.innerHTML = `
          <span class="chat-title">${chat.title}</span>
          <div class="chat-menu">
            <button class="chat-menu-btn" title="Options"><i class="fi fi-rr-file-edit"></i></button>
            <div class="chat-menu-dropdown">
              <button class="chat-rename">Rename</button>
              <button class="chat-delete">Delete</button>
            </div>
          </div>
        `;
            chatsSection.appendChild(node);
            setActiveChatItemById(chat.id);
          }

          showChatUI();
          addMessage(message, "user");
          resetInput();
          sendButton.disabled = true;

          // Show loading animation based on mode
          if (videoMode) {
            showLoadingMessage('video');
          } else {
            showLoadingMessage('thinking');
          }

          let data;
          if (videoMode) {
            const res = await fetch(
              `/api/chats/${activeChatId}/generate_video`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ topic: message }),
              }
            );
            if (!res.ok) throw new Error("Gagal membuat video");
            data = await res.json();
            removeLoadingMessage();
            addMessage(data.message, "ai", data.video_url);
          } else {
            data = await postMessage(activeChatId, message);
            removeLoadingMessage();
            addMessage(
              data.ai_message.content,
              "ai",
              data.ai_message.video_url
            );
          }
        } catch (err) {
          removeLoadingMessage();
          console.error(err);
          alert("Failed to send message");
        } finally {
          sendButton.disabled = false;
        }
      }

      if (sendButton) {
        sendButton.addEventListener("click", sendMessage);
      }
      if (messageInput) {
        messageInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }

      // Auto-load pesan untuk chat yang sudah active
      (async function initAutoLoadActive() {
        const firstActive = document.querySelector(".chat-item.active");
        if (firstActive && firstActive.dataset.chatId) {
          try {
            const msgs = await loadMessages(firstActive.dataset.chatId);
            ensureNotEmptyState();
            chatMessages.innerHTML = "";
            showChatUI();
            msgs.forEach((m) => addMessage(m.content, m.role, m.video_url));
            activeChatId = firstActive.dataset.chatId;
            setTimeout(() => {
              chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: "smooth",
              });
            }, 300);
          } catch (e) {
            console.warn("No initial messages loaded:", e);
          }
        }
      })();

      // Chat menu: toggle, rename, delete
      function closeAllChatMenus(except) {
        document.querySelectorAll(".chat-menu").forEach((m) => {
          if (m !== except) m.classList.remove("open");
        });
      }

      chatsSection.addEventListener("click", (e) => {
        const btn = e.target.closest(".chat-menu-btn");
        if (!btn) return;
        e.stopPropagation();
        const menu = btn.closest(".chat-menu");
        const isOpen = menu.classList.contains("open");
        closeAllChatMenus(menu);
        if (!isOpen) menu.classList.add("open");
      });

      document.addEventListener("click", () => closeAllChatMenus(null));

      // Handler RENAME
      chatsSection.addEventListener("click", async (e) => {
        const btn = e.target.closest(".chat-rename");
        if (!btn) return;

        e.stopPropagation();
        const item = btn.closest(".chat-item");
        const chatId = item?.dataset?.chatId;
        if (!chatId) return;

        const titleSpan = item.querySelector(".chat-title");
        const currentTitle = titleSpan?.textContent?.trim() || "Untitled";

        const newTitle = await openModal({
          title: "âœï¸ Rename Chat",
          placeholder: "Enter new title...",
          defaultValue: currentTitle,
        });
        if (newTitle === null) return;
        const cleaned = (newTitle || "").trim();
        if (!cleaned || cleaned === currentTitle) return;

        try {
          const res = await fetch(`/api/chats/${chatId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: cleaned }),
          });
          if (!res.ok) throw new Error("Rename failed");
          const data = await res.json();

          titleSpan.textContent = data.title;
          closeAllChatMenus(null);
        } catch (err) {
          console.error(err);
          alert("Failed to rename chat");
        }
      });

      // Handler DELETE
      chatsSection.addEventListener("click", async (e) => {
        const btn = e.target.closest(".chat-delete");
        if (!btn) return;

        e.stopPropagation();
        const item = btn.closest(".chat-item");
        const chatId = item?.dataset?.chatId;
        if (!chatId) return;

        const confirmDelete = await openModal({
          title: "Delete Chat",
          message: "This action cannot be undone!",
          icon: "https://cdn-icons-png.flaticon.com/512/1214/1214428.png",
          isConfirm: true,
        });
        if (!confirmDelete) return;

        try {
          const res = await fetch(`/api/chats/${chatId}`, { method: "DELETE" });
          if (!res.ok) throw new Error("Delete failed");

          const deletingActive = item.classList.contains("active");
          item.remove();

          if (!document.querySelector(".chat-item")) {
            const placeholder = document.createElement("div");
            placeholder.id = "empty-state";
            placeholder.className = "chat-item empty";
            placeholder.textContent = "No chats yet";
            chatsSection.appendChild(placeholder);
          }

          if (deletingActive) {
            chatMessages.innerHTML = "";
            chatMessages.style.display = "none";
            welcomeScreen.classList.remove("hidden");
            activeChatId = null;

            const first = document.querySelector(".chat-item[data-chat-id]");
            if (first) {
              first.classList.add("active");
              activeChatId = first.dataset.chatId;
              try {
                const msgs = await loadMessages(activeChatId);
                chatMessages.innerHTML = "";
                showChatUI();
                msgs.forEach((m) => addMessage(m.content, m.role));
              } catch {}
            }
          }

          closeAllChatMenus(null);
        } catch (err) {
          console.error(err);
          alert("Failed to delete chat");
        }
      });

      // Search chats
      const chatSearchInput = document.getElementById("chat-search");
      const chatSearchClear = document.getElementById("chat-search-clear");

      function renderChatList(chats) {
        const container = document.getElementById("chats-section");
        if (!container) return;

        const titleHtml = '<div class="chats-title">Your Chats</div>';
        let listHtml = "";
        if (chats.length === 0) {
          listHtml =
            '<div id="empty-state" class="chat-item empty">No chats yet</div>';
        } else {
          listHtml = chats
            .map(
              (c) => `
        <div class="chat-item${
          activeChatId && String(activeChatId) === String(c.id) ? " active" : ""
        }" data-chat-id="${c.id}">
          <span class="chat-title">${escapeHtml(c.title)}</span>
          <div class="chat-menu">
            <button class="chat-menu-btn" title="Options"><i class="fi fi-rr-file-edit"></i></button>
            <div class="chat-menu-dropdown">
              <button class="chat-rename">Rename</button>
              <button class="chat-delete">Delete</button>
            </div>
          </div>
        </div>
      `
            )
            .join("");
        }
        container.innerHTML = titleHtml + listHtml;
      }

      function debounce(fn, ms = 250) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }

      async function fetchSearchResults(query) {
        const url = "/api/chats/search?q=" + encodeURIComponent(query || "");
        const res = await fetch(url);
        if (!res.ok) throw new Error("Search failed");
        return res.json();
      }

      const doSearch = debounce(async () => {
        try {
          const q = chatSearchInput.value.trim();
          chatSearchClear.classList.toggle("show", q.length > 0);

          const result = await fetchSearchResults(q);
          renderChatList(result);
        } catch (e) {
          console.error(e);
        }
      }, 300);

      if (chatSearchInput) {
        chatSearchInput.addEventListener("input", doSearch);
        chatSearchInput.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            chatSearchInput.value = "";
            doSearch();
            chatSearchInput.blur();
          }
        });
      }
      if (chatSearchClear) {
        chatSearchClear.addEventListener("click", () => {
          chatSearchInput.value = "";
          chatSearchInput.focus();
          doSearch();
        });
      }

      // Toggle Mode: Buat Video
      const uploadBtnEl = document.getElementById("upload-btn");

      if (uploadBtnEl) {
        uploadBtnEl.addEventListener("click", () => {
          videoMode = !videoMode;
          uploadBtnEl.classList.toggle("active", videoMode);

          if (videoMode) {
            uploadBtnEl.title =
              "Mode Video Aktif ðŸŽ¬ (klik lagi untuk nonaktif)";
            showPopup("ðŸŽ¬ Mode pembuatan video diaktifkan", "success");
          } else {
            uploadBtnEl.title = "Buat Video";
            showPopup(
              "ðŸ’¬ Mode video dinonaktifkan. Kembali ke mode chat biasa",
              "info"
            );
          }
        });
      }

      // Global polling untuk update pesan baru
      setInterval(async () => {
        try {
          if (!activeChatId) return;

          const msgs = await loadMessages(activeChatId);
          const currentMsgs = Array.from(document.querySelectorAll(".message"));
          const currentCount = currentMsgs.length;

          if (msgs.length > currentCount) {
            const newMsgs = msgs.slice(currentCount);
            newMsgs.forEach((m) => addMessage(m.content, m.role, m.video_url));
          }
        } catch (err) {
          console.warn("Auto refresh error:", err);
        }
      }, 5000);

      // Draggable Floating Review Button
      const floatingBtn = document.getElementById("floatingReviewBtn");

      if (floatingBtn) {
        let isDragging = false;
        let offsetX, offsetY;

        floatingBtn.addEventListener("mousedown", function (e) {
          if (e.target.closest("a")) return;

          isDragging = true;
          floatingBtn.classList.remove("bounce");

          const rect = floatingBtn.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;

          e.preventDefault();
        });

        floatingBtn.addEventListener("click", function (e) {
          if (!isDragging) {
            window.location.href = "/reviews";
          }
        });

        document.addEventListener("mousemove", function (e) {
          if (!isDragging) return;

          const x = e.clientX - offsetX;
          const y = e.clientY - offsetY;

          const maxX = window.innerWidth - floatingBtn.offsetWidth;
          const maxY = window.innerHeight - floatingBtn.offsetHeight;

          const finalX = Math.max(0, Math.min(x, maxX));
          const finalY = Math.max(0, Math.min(y, maxY));

          floatingBtn.style.left = finalX + "px";
          floatingBtn.style.top = finalY + "px";
          floatingBtn.style.right = "auto";
          floatingBtn.style.bottom = "auto";
        });

        document.addEventListener("mouseup", function () {
          isDragging = false;
        });

        // Touch support untuk mobile
        floatingBtn.addEventListener("touchstart", function (e) {
          isDragging = true;
          floatingBtn.classList.remove("bounce");

          const rect = floatingBtn.getBoundingClientRect();
          const touch = e.touches[0];
          offsetX = touch.clientX - rect.left;
          offsetY = touch.clientY - rect.top;
        });

        document.addEventListener("touchmove", function (e) {
          if (!isDragging) return;

          const touch = e.touches[0];
          const x = touch.clientX - offsetX;
          const y = touch.clientY - offsetY;

          const maxX = window.innerWidth - floatingBtn.offsetWidth;
          const maxY = window.innerHeight - floatingBtn.offsetHeight;

          const finalX = Math.max(0, Math.min(x, maxX));
          const finalY = Math.max(0, Math.min(y, maxY));

          floatingBtn.style.left = finalX + "px";
          floatingBtn.style.top = finalY + "px";
          floatingBtn.style.right = "auto";
          floatingBtn.style.bottom = "auto";

          e.preventDefault();
        });

        document.addEventListener("touchend", function () {
          isDragging = false;
        });
      }

      // Saat pertama load, tampilkan semua
      doSearch();

      // Modal Helper
      function openModal({
        title,
        message = "",
        icon = "",
        placeholder = "",
        defaultValue = "",
        isConfirm = false,
      }) {
        return new Promise((resolve) => {
          const overlay = document.getElementById("modal-overlay");
          const titleEl = document.getElementById("modal-title");
          const msgEl = document.getElementById("modal-message");
          const iconEl = document.getElementById("modal-icon");
          const inputEl = document.getElementById("modal-input");
          const okBtn = document.getElementById("modal-ok");
          const cancelBtn = document.getElementById("modal-cancel");

          titleEl.textContent = title;
          msgEl.textContent = message;
          iconEl.src = icon || "";
          iconEl.style.display = icon ? "block" : "none";
          inputEl.style.display = isConfirm ? "none" : "block";
          inputEl.placeholder = placeholder;
          inputEl.value = defaultValue;

          overlay.style.display = "flex";
          if (!isConfirm) inputEl.focus();

          function closeModal(value) {
            overlay.style.display = "none";
            okBtn.removeEventListener("click", onOk);
            cancelBtn.removeEventListener("click", onCancel);
            inputEl.removeEventListener("keydown", onEnter);
            resolve(value);
          }

          function onOk() {
            const val = isConfirm ? true : inputEl.value.trim();
            closeModal(val || null);
          }
          function onCancel() {
            closeModal(null);
          }
          function onEnter(e) {
            if (e.key === "Enter") onOk();
          }

          okBtn.addEventListener("click", onOk);
          cancelBtn.addEventListener("click", onCancel);
          inputEl.addEventListener("keydown", onEnter);
        });
      }
    </script>
  </body>
</html>