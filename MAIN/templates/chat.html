<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content"
    />
    <title>LearnVid AI - Chat</title>
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/2.4.2/uicons-regular-rounded/css/uicons-regular-rounded.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="icon" type="image/svg+xml" href="/learnvid-ai/static/logo.svg" />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap");

      @font-face {
        font-family: "Cabinet Grotesk";
        src: url("{{ url_for('static', path='font/CabinetGrotesk-Regular.woff2') }}")
            format("woff2"),
          url("{{ url_for('static', path='font/CabinetGrotesk-Regular.woff') }}")
            format("woff");
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }

      :root {
        --bg: #f7f8fb;
        --panel: #ffffff;
        --primary: #3f72af;
        --primary-strong: #2b5691;
        --ink: #0f1b2d;
        --muted: #7c8aab;
        --border: #e5e9f2;
        --bubble-user: #dbe2ef;
        --bubble-ai: #3f72af;
        --shadow-soft: 0 18px 60px rgba(17, 45, 78, 0.08);
        --radius-lg: 20px;
        --radius-pill: 999px;
        --grad: radial-gradient(
          circle at 20% 20%,
          rgba(63, 114, 175, 0.18),
          transparent 30%
        ),
          radial-gradient(
            circle at 80% 0%,
            rgba(17, 45, 78, 0.15),
            transparent 28%
          ),
          radial-gradient(
            circle at 60% 90%,
            rgba(179, 204, 235, 0.2),
            transparent 30%
          );
        --font-display: "Cabinet Grotesk", sans-serif;
        --font-body: "Montserrat", sans-serif;
      }

      /* Reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: var(--font-body);
        background: var(--bg);
        color: var(--ink);
        height: 100dvh;
        overflow: hidden;
        position: relative;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: var(--font-display);
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: var(--grad);
        opacity: 0.65;
        z-index: 0;
        pointer-events: none;
      }

      /* CSS untuk Loader (ditambahkan dari file asli Anda) */
      .loading-content {
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--ink);
      }
      .loader {
        width: 40px;
        aspect-ratio: 2;
        --_g: no-repeat
          radial-gradient(circle closest-side, var(--panel) 90%, transparent);
        background: var(--_g) 0% 50%, var(--_g) 50% 50%, var(--_g) 100% 50%;
        background-size: calc(100% / 3) 50%;
        animation: l3 1s infinite linear;
        display: inline-block;
        filter: drop-shadow(0 3px 6px rgba(15, 27, 45, 0.18));
      }
      .loading-text {
        font-weight: 600;
        letter-spacing: 0.01em;
      }
      .video-loading {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 180px;
      }
      .status-list {
        display: grid;
        gap: 6px;
        padding: 6px 0;
      }
      .status-item {
        display: grid;
        grid-template-columns: 18px 1fr;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        padding: 8px 10px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .status-item.current {
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: 0 10px 30px rgba(17, 45, 78, 0.08);
      }
      .status-item.complete {
        opacity: 0.8;
      }
      .status-item.error {
        background: rgba(209, 26, 42, 0.12);
        border-color: rgba(209, 26, 42, 0.3);
      }
      .status-icon {
        font-weight: 700;
      }
      .status-text {
        word-break: break-word;
      }
      .video-progress-bar {
        width: 100%;
        height: 5px;
        background: rgba(249, 247, 247, 0.22);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      .video-progress-fill {
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, #f9f7f7, rgba(255, 255, 255, 0.6));
        animation: indeterminate-progress 2s infinite linear;
      }
      @keyframes l3 {
        20% {
          background-position: 0% 0%, 50% 50%, 100% 50%;
        }
        40% {
          background-position: 0% 100%, 50% 0%, 100% 50%;
        }
        60% {
          background-position: 0% 50%, 50% 100%, 100% 0%;
        }
        80% {
          background-position: 0% 50%, 50% 50%, 100% 100%;
        }
      }
      @keyframes indeterminate-progress {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }
      @keyframes messageIn {
        from {
          transform: translateY(10px) scale(0.99);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }
      @keyframes bounceDots {
        0%,
        80%,
        100% {
          transform: scale(0);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }
      /* ---------------------------------- */

      .upload-btn.active {
        background: var(--primary);
        border: 1px solid var(--primary-strong);
        box-shadow: 0 12px 30px rgba(63, 114, 175, 0.35),
          0 0 0 4px rgba(63, 114, 175, 0.12);
        color: #f9f7f7;
        transform: translateY(-1px) scale(1.02);
      }
      .upload-btn.active svg {
        stroke: #f9f7f7;
      }

      .container {
        display: flex;
        height: 100dvh;
        position: relative;
        z-index: 1;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: #112d4e;
        color: #f9f7f7;
        display: flex;
        flex-direction: column;
        border-right: 1px solid rgba(219, 226, 239, 0.1);
        transition: transform 0.3s ease;
        font-family: var(--font-body);
      }

      /* Mobile Sidebar Toggle */
      .mobile-sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 998;
        backdrop-filter: blur(2px);
      }

      .mobile-sidebar-toggle {
        display: none;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 1001;
        background: #112d4e;
        color: #f9f7f7;
        border: none;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .mobile-sidebar-toggle svg {
        width: 24px;
        height: 24px;
        stroke: #f9f7f7;
      }

      /* --- SIDEBAR HEADER BARU --- */
      .sidebar-header {
        padding: 20px 16px;
        border-bottom: 1px solid rgba(219, 226, 239, 0.1);
      }
      .sidebar-logo {
        font-size: 1.25rem;
        font-weight: 500;
        color: #f9f7f7;
        padding-left: 5px;
        font-family: var(--font-display);
      }
      /* ------------------------------- */

      .sidebar-menu {
        padding: 8px 12px;
        flex: 1;
        overflow-y: auto;
      }

      /* --- MENU ITEM BARU --- */
      .menu-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        margin-bottom: 4px;
        color: #dbe2ef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        text-decoration: none;
      }
      .menu-item:hover {
        background: rgba(219, 226, 239, 0.1);
        color: #f9f7f7;
      }
      .menu-item.active {
        background: #3f72af;
        color: #f9f7f7;
      }
      .menu-item svg {
        width: 18px;
        height: 18px;
      }
      .menu-item i {
        font-size: 18px;
      }
      /* --------------------- */

      .chats-section {
        margin-top: 15px;
      }
      .chats-title {
        color: #dbe2ef;
        font-size: 11px;
        opacity: 0.7;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        padding: 0 12px;
      }

      .chat-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        margin-bottom: 2px;
        position: relative;
        color: #dbe2ef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        line-height: 1.4;
      }
      .chat-item:hover {
        background: rgba(219, 226, 239, 0.1);
      }
      .chat-item.active {
        background: #3f72af;
        color: #f9f7f7;
      }

      .chat-title {
        flex: 1;
        margin-right: 8px;
        max-width: 180px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
        vertical-align: middle;
      }

      .chat-menu {
        position: relative;
      }
      .chat-menu-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        color: #666;
        display: inline-flex;
        align-items: center;
        padding: 4px;
      }
      .chat-menu-btn i {
        font-size: 18px;
        color: #fff;
      }

      .chat-menu-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 4px 0;
        min-width: 120px;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .chat-menu.open .chat-menu-dropdown {
        display: block;
      }
      .chat-menu-dropdown button {
        display: block;
        width: 100%;
        padding: 8px 12px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        color: #112d4e;
      }
      .chat-menu-dropdown button:hover {
        background: #f3f3f3;
      }

      .sidebar-footer {
        padding: 12px;
        border-top: 1px solid rgba(219, 226, 239, 0.1);
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.2s;
      }
      .user-info:hover {
        background: rgba(219, 226, 239, 0.1);
      }
      .user-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #3f72af;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }
      .username {
        color: #dbe2ef;
        font-size: 14px;
      }

      /* Main Chat Area */
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.85),
            rgba(255, 255, 255, 0.78)
          ),
          var(--grad);
        backdrop-filter: blur(6px);
      }
      .chat-header {
        position: sticky;
        top: 0;
        z-index: 5;
        padding: 14px 18px;
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(17, 45, 78, 0.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.03);
      }
      .chat-header .chat-title {
        font-family: var(--font-display);
        font-size: 1.2rem;
        color: var(--ink);
        max-width: none;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        letter-spacing: -0.01em;
      }
      .chat-actions {
        display: flex;
        gap: 8px;
      }
      .action-btn {
        padding: 8px 14px;
        background: rgba(63, 114, 175, 0.08);
        border: 1px solid rgba(17, 45, 78, 0.12);
        border-radius: var(--radius-pill);
        color: var(--primary);
        cursor: pointer;
        transition: 0.2s ease;
        font-size: 12px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 10px 30px rgba(17, 45, 78, 0.06);
      }
      .action-btn:hover {
        background: rgba(63, 114, 175, 0.16);
        color: var(--ink);
        transform: translateY(-1px);
      }

      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        position: relative;
        background: radial-gradient(
            circle at 20% 30%,
            rgba(63, 114, 175, 0.05),
            transparent 26%
          ),
          radial-gradient(
            circle at 80% 10%,
            rgba(17, 45, 78, 0.05),
            transparent 22%
          ),
          linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.9),
            rgba(255, 255, 255, 0.8)
          );
      }
      .chat-container::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.9) 0%,
            transparent 22%
          ),
          linear-gradient(0deg, rgba(255, 255, 255, 0.9) 0%, transparent 18%);
        z-index: 1;
      }

      .welcome-screen {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 52px 40px;
        position: relative;
        z-index: 2;
        gap: 14px;
      }
      .welcome-screen.hidden {
        display: none;
      }
      .welcome-title {
        font-family: var(--font-display);
        font-size: 2.6rem;
        color: var(--ink);
        margin-bottom: 10px;
        letter-spacing: -0.02em;
      }
      .welcome-subtitle {
        color: var(--primary);
        font-size: 1.1rem;
        opacity: 0.9;
        max-width: 520px;
      }

      .chat-messages {
        flex: 1;
        padding: 28px 20px 24px;
        display: none;
        overflow-y: auto;
        position: relative;
        z-index: 2;
        scroll-behavior: smooth;
      }

      .message {
        margin-bottom: 22px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        animation: messageIn 0.28s ease;
      }
      .message.user {
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 34px;
        height: 34px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        flex-shrink: 0;
        box-shadow: var(--shadow-soft);
      }
      .message.ai .message-avatar {
        background: var(--primary);
        color: #f9f7f7;
      }
      .message.user .message-avatar {
        background: var(--bubble-user);
        color: var(--ink);
      }

      .message-content {
        max-width: 70%;
        padding: 16px 20px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.5;
        position: relative;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(17, 45, 78, 0.04);
      }
      .message-content ul,
      .message-content ol {
        margin: 10px 0;
        padding-left: 18px;
        list-style-position: inside;
      }
      .message-content li {
        margin: 4px 0;
        padding-left: 2px;
      }
      .message-content ul ul,
      .message-content ol ul,
      .message-content ol ol,
      .message-content ul ol {
        margin: 6px 0 0 12px;
      }
      .message-content p + p {
        margin-top: 10px;
      }
      .message-content a {
        color: inherit;
        text-decoration: underline;
        text-decoration-thickness: 2px;
        text-underline-offset: 3px;
      }
      .message-content video {
        border-radius: 12px;
        box-shadow: var(--shadow-soft);
      }
      .message.ai .message-content {
        background: var(--bubble-ai);
        color: #f9f7f7;
        border-bottom-left-radius: 6px;
        backdrop-filter: blur(4px);
      }
      .message.user .message-content {
        background: var(--bubble-user);
        color: var(--ink);
        border-bottom-right-radius: 6px;
      }

      /* Input Area */
      .input-area {
        padding: 18px 20px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.9),
          rgba(247, 248, 251, 0.95)
        );
        padding-bottom: calc(18px + env(safe-area-inset-bottom));
        position: sticky;
        bottom: 0;
        z-index: 5;
        box-shadow: 0 -12px 30px rgba(17, 45, 78, 0.04);
      }
      .input-container {
        max-width: 860px;
        margin: 0 auto;
        position: relative;
        background: var(--panel);
        border-radius: 30px;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        min-height: 58px;
        transition: 0.25s ease;
        box-shadow: var(--shadow-soft);
      }
      .input-container:focus-within {
        border-color: rgba(63, 114, 175, 0.35);
        box-shadow: 0 15px 40px rgba(17, 45, 78, 0.12);
        transform: translateY(-1px);
      }

      .upload-btn {
        width: 46px;
        height: 46px;
        margin: 6px;
        background: #dfe8f7;
        border: 1px solid #d1dcf0;
        cursor: pointer;
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: 0.2s ease;
        position: relative;
        backdrop-filter: blur(8px);
        box-shadow: 0 10px 28px rgba(17, 45, 78, 0.08);
      }
      .upload-btn-bubble {
        --bubble-shift: 0px;
        position: absolute;
        bottom: 54px;
        left: 50%;
        transform: translate(calc(-50% + var(--bubble-shift)), -6px);
        background: var(--panel);
        color: var(--ink);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px 12px;
        box-shadow: 0 14px 36px rgba(17, 45, 78, 0.16);
        font-size: 12px;
        line-height: 1.4;
        white-space: nowrap;
        text-align: center;
        max-width: none;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 10;
      }
      .upload-btn-bubble::after {
        content: "";
        position: absolute;
        bottom: -6px;
        left: calc(50% - var(--bubble-shift));
        transform: translateX(-50%);
        border-width: 6px 7px 0 7px;
        border-style: solid;
        border-color: var(--panel) transparent transparent transparent;
        filter: drop-shadow(0 -1px 1px rgba(17, 45, 78, 0.08));
      }
      .upload-btn:hover {
        background: #e6eeff;
        color: var(--primary-strong);
        border-color: #cdd8f0;
        box-shadow: 0 12px 30px rgba(17, 45, 78, 0.1);
        transform: translateY(-0.5px);
      }
      .upload-btn.active:hover {
        background: var(--primary);
        color: #f9f7f7;
        border-color: var(--primary-strong);
        box-shadow: 0 12px 30px rgba(63, 114, 175, 0.35),
          0 0 0 4px rgba(63, 114, 175, 0.12);
        transform: translateY(-1px);
      }
      .upload-btn svg {
        width: 20px;
        height: 20px;
      }
      .video-state {
        position: absolute;
        left: 12px;
        bottom: calc(100% + 8px);
        background: var(--panel);
        color: var(--ink);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 6px 10px;
        font-size: 12px;
        line-height: 1.3;
        box-shadow: var(--shadow-soft);
        display: flex;
        align-items: center;
        gap: 6px;
        pointer-events: none;
        max-width: calc(100% - 40px);
        white-space: normal;
        visibility: hidden;
        opacity: 0;
        transform: translateY(-4px);
        transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
      }
      .video-state-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--muted);
        flex-shrink: 0;
      }
      .video-state.on {
        color: #0f2b55;
        border-color: rgba(63, 114, 175, 0.3);
        background: #e8f0ff;
        box-shadow: 0 10px 24px rgba(63, 114, 175, 0.18);
      }
      .video-state.on .video-state-dot {
        background: var(--primary);
      }
      .video-state.show {
        visibility: visible;
        opacity: 1;
        transform: translateY(0);
      }

      .message-input {
        flex: 1;
        padding: 16px 12px;
        min-height: 26px;
        max-height: 160px;
        border: none;
        background: transparent;
        outline: none;
        resize: none;
        font-family: var(--font-body);
        font-size: 15px;
        color: var(--ink);
        line-height: 1.55;
      }
      .message-input::placeholder {
        color: var(--muted);
        opacity: 0.7;
      }

      .send-button {
        width: 46px;
        height: 46px;
        margin: 6px;
        background: #dfe8f7;
        border: 1px solid #d1dcf0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: 0.2s ease;
        box-shadow: 0 10px 28px rgba(17, 45, 78, 0.08);
      }
      .send-button:disabled {
        opacity: 0.35;
        cursor: not-allowed;
        box-shadow: none;
      }
      .send-button:not(:disabled):hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 32px rgba(63, 114, 175, 0.28);
      }
      .send-button svg {
        width: 20px;
        height: 20px;
        color: var(--primary);
      }

      .file-input {
        display: none;
      }

      /* Floating Review Button (dihapus dari chat.html agar tidak duplikat) */

      /* Modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
        backdrop-filter: blur(2px);
        animation: fadeIn 0.25s ease;
      }
      .modal {
        background: #f9f7f7;
        color: #112d4e;
        border-radius: 10px;
        padding: 24px;
        width: 90%;
        max-width: 300px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
      }
      .modal h2 {
        margin-top: 0;
        font-size: 1.2rem;
        font-weight: bold;
      }
      .modal-input {
        width: 100%;
        margin-top: 10px;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        outline: none;
        font-size: 15px;
      }
      .modal-input:focus {
        border-color: #3f72af;
        box-shadow: 0 0 0 2px rgba(63, 114, 175, 0.2);
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 18px;
        gap: 10px;
      }
      .modal-btn {
        padding: 7px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      .modal-btn.cancel {
        background: #ddd;
        color: #333;
      }
      .modal-btn.ok {
        background: #3f72af;
        color: white;
      }
      .modal-btn.ok:hover {
        background: #2b5691;
      }
      .modal-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .modal-message {
        margin: 8px 0 16px 0;
        font-size: 0.95rem;
        color: #2b3a55;
        text-align: left;
      }
      .modal-icon {
        width: 20px;
        height: 20px;
      }
      .chat-delete {
        color: #d11a2a;
        font-weight: 600;
      }
      .chat-delete:hover {
        background: #ffe5e5 !important;
        color: #a00;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          transform: translateY(15px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* ===== RESPONSIVE STYLES ===== */
      @media (max-width: 1024px) {
        .sidebar {
          width: 240px;
        }
        .chat-title {
          max-width: 140px;
        }
        .message-content {
          max-width: 75%;
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          height: 100dvh;
          z-index: 999;
          transform: translateX(-100%);
          width: 280px;
          padding-bottom: env(safe-area-inset-bottom);
        }

        .sidebar.open {
          transform: translateX(0);
        }

        .sidebar.open .sidebar-logo {
          pointer-events: none;
          padding-left: 60px;
        }

        .sidebar-footer {
          padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        .mobile-sidebar-overlay {
          display: none;
        }

        .mobile-sidebar-overlay.active {
          display: block;
        }

        .mobile-sidebar-toggle {
          display: block;
        }
        .chat-main {
          width: 100%;
        }
        .chat-header {
          padding: 12px 60px 12px 65px;
        } /* Disesuaikan dengan padding responsif sebelumnya */
        .chat-header .chat-title {
          font-size: 1rem;
        }
        .action-btn {
          padding: 5px 10px;
          font-size: 11px;
        }
        .welcome-title {
          font-size: 2rem;
        }
        .welcome-subtitle {
          font-size: 1rem;
        }
        .chat-messages {
          padding: 18px 14px;
        }
        .message {
          gap: 8px;
        }
        .message-content {
          max-width: 80%;
          padding: 12px 16px;
          font-size: 13px;
        }
        .input-area {
          padding: 16px 12px;
        }
        .input-container {
          border-radius: 24px;
        }
        .message-input {
          font-size: 14px;
          padding: 10px 12px;
        }
        .modal {
          padding: 20px;
          max-width: 280px;
        }
        .modal h2 {
          font-size: 1.1rem;
        }
      }

      @media (max-width: 600px) {
        .sidebar {
          width: 260px;
        }
        .chat-header {
          padding: 10px 55px 10px 65px;
        }
        .welcome-screen {
          padding: 30px 20px;
        }
        .welcome-title {
          font-size: 1.8rem;
        }
        .welcome-subtitle {
          font-size: 0.95rem;
        }
        .message-avatar {
          width: 28px;
          height: 28px;
          font-size: 11px;
        }
        .message-content {
          padding: 10px 14px;
          font-size: 13px;
          max-width: 85%;
        }
        .upload-btn-bubble {
          position: fixed;
          bottom: auto;
          left: 50%;
          right: auto;
          transform: translate(-50%, -10px);
          white-space: normal;
          text-align: center;
          word-break: break-word;
          max-width: calc(100vw - 32px);
          min-width: 140px;
        }
        .upload-btn-bubble::after {
          left: 50%;
          transform: translateX(-50%);
        }
        .upload-btn,
        .send-button {
          width: 42px;
          height: 42px;
          margin: 5px;
        }
        .upload-btn svg,
        .send-button svg {
          width: 18px;
          height: 18px;
        }
      }

      @media (max-width: 480px) {
        .sidebar {
          width: 240px;
        }
        .mobile-sidebar-toggle {
          top: 12px;
          left: 12px;
          padding: 8px;
        }
        .mobile-sidebar-toggle svg {
          width: 20px;
          height: 20px;
        }
        .chat-header {
          padding: 8px 50px 8px 55px;
        }
        .chat-header .chat-title {
          font-size: 0.95rem;
        }
        .action-btn {
          padding: 4px 8px;
          font-size: 10px;
        }
        .welcome-screen {
          padding: 20px 15px;
        }
        .welcome-title {
          font-size: 1.5rem;
          margin-bottom: 10px;
        }
        .welcome-subtitle {
          font-size: 0.9rem;
        }
        .chat-messages {
          padding: 12px 10px;
        }
        .message {
          margin-bottom: 16px;
        }
        .message-avatar {
          width: 26px;
          height: 26px;
          font-size: 10px;
        }
        .message-content {
          padding: 10px 12px;
          font-size: 12px;
          border-radius: 14px;
          max-width: 88%;
        }
        .input-area {
          padding: 12px 10px;
        }
        .input-container {
          min-height: 48px;
        }
        .message-input {
          font-size: 13px;
          padding: 8px 10px;
        }
        .upload-btn,
        .send-button {
          width: 40px;
          height: 40px;
          margin: 4px;
        }
        .upload-btn svg,
        .send-button svg {
          width: 16px;
          height: 16px;
        }
        .chat-item {
          font-size: 13px;
          padding: 7px 10px;
        }
        .username {
          font-size: 13px;
        }
        .modal {
          padding: 18px;
          max-width: 260px;
        }
        .modal h2 {
          font-size: 1rem;
        }
        .modal-input {
          font-size: 14px;
          padding: 8px 10px;
        }
        .modal-btn {
          padding: 6px 12px;
          font-size: 13px;
        }
      }

      @media (max-width: 360px) {
        .sidebar {
          width: 220px;
        }
        .welcome-title {
          font-size: 1.3rem;
        }
        .message-content {
          max-width: 90%;
        }
      }

      @media (max-height: 600px) and (orientation: landscape) {
        .welcome-screen {
          padding: 20px 15px;
        }
        .welcome-title {
          font-size: 1.5rem;
          margin-bottom: 8px;
        }
        .welcome-subtitle {
          font-size: 0.9rem;
        }
        .chat-messages {
          padding: 10px;
        }
        .message {
          margin-bottom: 12px;
        }
        .input-area {
          padding: 10px;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation-duration: 0.001ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.001ms !important;
          scroll-behavior: auto !important;
        }
      }

      /* === LOADER VIDEO (SPINNER KECIL PUTIH) === */
      .loader-video {
        width: 18px;            /* kecil */
        padding: 4px;
        aspect-ratio: 1;
        border-radius: 50%;
        background: #ffffff;    /* warna putih */
        --_m: 
          conic-gradient(#0000 10%, #000),
          linear-gradient(#000 0 0) content-box;
        -webkit-mask: var(--_m);
                mask: var(--_m);
        -webkit-mask-composite: source-out;
                mask-composite: subtract;
        display: inline-block;
        animation: video-spin 1s infinite linear;
      }

      @keyframes video-spin {
        to { transform: rotate(1turn); }
      }

      /* Pastikan spinner tetap berputar meski prefers-reduced-motion: reduce */
      @media (prefers-reduced-motion: reduce) {
        .loader-video {
          animation-duration: 1s !important;
          animation-iteration-count: infinite !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button
        class="mobile-sidebar-toggle"
        id="mobileSidebarToggle"
        aria-label="Toggle sidebar"
      >
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M3 12h18M3 6h18M3 18h18" />
        </svg>
      </button>

      <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay"></div>

      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo">LearnVid AI</div>
        </div>

        <div class="sidebar-menu">
          <a
            href="/learnvid-ai/chat"
            class="menu-item {% if not request.query_params.get('id') %}active{% endif %}"
          >
            <i class="bi bi-plus-circle"></i>
            New Chat
          </a>
          <a href="/learnvid-ai/gallery" class="menu-item">
            <i class="bi bi-bookmark"></i>
            Gallery
          </a>

          <div class="chats-section" id="chats-section">
            <div class="chats-title">Chats</div>
            {% if chats and chats|length > 0 %} {% for c in chats %}
            <div
              class="chat-item {% if c.id|string == request.query_params.get('id') %}active{% endif %}"
              data-chat-id="{{ c.id }}"
            >
              <span class="chat-title">{{ c.title }}</span>
              <div class="chat-menu">
                <button class="chat-menu-btn" title="Options">
                  <i class="bi bi-three-dots"></i>
                </button>
                <div class="chat-menu-dropdown">
                  <button class="chat-rename">Rename</button>
                  <button class="chat-delete">Delete</button>
                </div>
              </div>
            </div>
            {% endfor %} {% else %}
            <div id="empty-state" class="chat-item empty">No chats yet</div>
            {% endif %}
          </div>
        </div>

        <div class="sidebar-footer">
          <div class="user-info">
            <div class="user-avatar">U</div>
            <div class="username">{{username}}</div>
          </div>
        </div>
      </div>
      <div class="chat-main">
        <div class="chat-header">
          <div class="chat-title">LearnVid AI</div>
          <div class="chat-actions">
            <a href="/learnvid-ai/logout" class="action-btn">Log out</a>
          </div>
        </div>

        <div class="chat-container">
          <div class="welcome-screen" id="welcome-screen">
            <h1 class="welcome-title">Welcome, {{username}}!</h1>
            <p class="welcome-subtitle">What should we learn today?</p>
          </div>

          <div
            class="chat-messages"
            id="chat-messages"
            aria-live="polite"
          aria-label="Chat messages"
          ></div>
        </div>

        <div class="input-area">
          <div class="input-container">
            <div class="video-state" id="video-state">
              <span class="video-state-dot"></span>
              <span class="video-state-label">Video off</span>
            </div>
            <div class="upload-btn" id="upload-btn" title="Buat Video">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <polygon points="23 7 16 12 23 17 23 7" />
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
              </svg>
            </div>

            <textarea
              class="message-input"
              id="message-input"
              placeholder="Ask anything"
              rows="1"
            ></textarea>

            <button class="send-button" id="send-button" disabled>
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path d="M22 2L11 13" />
                <path d="M22 2l-7 20-4-9-9-4 20-7z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <input type="file" id="image-upload" class="file-input" accept="image/*" />
    <input
      type="file"
      id="document-upload"
      class="file-input"
      accept=".pdf,.doc,.docx,.txt"
    />
    <input type="file" id="video-upload" class="file-input" accept="video/*" />

    <div id="modal-overlay" class="modal-overlay" style="display: none">
      <div class="modal">
        <div class="modal-header">
          <img id="modal-icon" class="modal-icon" alt="" />
          <h2 id="modal-title">Modal Title</h2>
        </div>
        <p id="modal-message" class="modal-message"></p>
        <input
          type="text"
          id="modal-input"
          class="modal-input"
          style="display: none"
        />
        <div class="modal-actions">
          <button id="modal-cancel" class="modal-btn cancel">Cancel</button>
          <button id="modal-ok" class="modal-btn ok">OK</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      // ====== User context dari Jinja ======
      const CURRENT_USERNAME = "{{ username }}";

      // ====== Elemen DOM (Sidebar) ======
      const chatsSection = document.querySelector(".chats-section");
      const sidebar = document.getElementById("sidebar");
      const mobileSidebarToggle = document.getElementById(
        "mobileSidebarToggle"
      );
      const mobileSidebarOverlay = document.getElementById(
        "mobileSidebarOverlay"
      );

      // ====== Elemen DOM (Chat) ======
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const chatMessages = document.getElementById("chat-messages");
      const welcomeScreen = document.getElementById("welcome-screen");
      const uploadBtn = document.getElementById("upload-btn");
      const chatHeaderTitle = document.querySelector(
        ".chat-header .chat-title"
      );

      // ====== State ======
      let videoMode = false;

      // Logika untuk menentukan activeChatId dari URL atau dari item pertama
      let activeChatId = (() => {
        const urlParams = new URLSearchParams(window.location.search);
        const urlChatId = urlParams.get("id");
        if (urlChatId) {
          const activeItem = document.querySelector(
            `.chat-item[data-chat-id="${urlChatId}"]`
          );
          if (activeItem) {
            return urlChatId;
          }
        }
        // Jika tidak ada di URL atau tidak valid, ambil yang pertama
        const firstActive = document.querySelector(".chat-item.active");
        return firstActive ? firstActive.dataset.chatId || null : null;
      })();

      function updateHeaderTitleFromActiveChat() {
        if (!chatHeaderTitle) return;
        if (!activeChatId) {
          chatHeaderTitle.textContent = "LearnVid AI";
          return;
        }
        const activeTitleEl = document.querySelector(
          `.chat-item[data-chat-id="${activeChatId}"] .chat-title`
        );
        const titleText = activeTitleEl?.textContent?.trim();
        chatHeaderTitle.textContent = titleText || "LearnVid AI";
      }

      // ====== Mobile Sidebar Toggle ======
      if (mobileSidebarToggle) {
        mobileSidebarToggle.addEventListener("click", function () {
          sidebar.classList.toggle("open");
          mobileSidebarOverlay.classList.toggle("active");
        });
      }

      if (mobileSidebarOverlay) {
        mobileSidebarOverlay.addEventListener("click", function () {
          sidebar.classList.remove("open");
          mobileSidebarOverlay.classList.remove("active");
        });
      }

      function closeMobileSidebar() {
        if (window.innerWidth <= 768) {
          sidebar.classList.remove("open");
          mobileSidebarOverlay.classList.remove("active");
        }
      }

      function escapeHtml(str = "") {
        return str.replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }

      // === Popup Helper ===
      function showPopup(message, type = "info") {
        const popup = document.createElement("div");
        popup.textContent = message;
        popup.className = `popup ${type}`;
        Object.assign(popup.style, {
          position: "fixed",
          top: "18px",
          right: "18px",
          background:
            type === "success"
              ? "linear-gradient(135deg, var(--primary), var(--primary-strong))"
              : type === "info"
              ? "linear-gradient(135deg, #2f5c9a, #3f72af)"
              : "linear-gradient(135deg, #0f1b2d, #1f2f45)",
          color: "#f9f7f7",
          padding: "10px 14px",
          borderRadius: "12px",
          boxShadow: "0 12px 35px rgba(17, 45, 78, 0.18)",
          fontSize: "13px",
          zIndex: 10000,
          opacity: "0",
          transition: "opacity 0.3s ease, transform 0.3s ease",
          transform: "translateY(-8px)",
          backdropFilter: "blur(8px)",
          border: "1px solid rgba(255,255,255,0.22)",
          maxWidth: "260px",
          textAlign: "center",
          pointerEvents: "none",
        });

        document.body.appendChild(popup);
        setTimeout(() => {
          popup.style.opacity = "1";
          popup.style.transform = "translateY(0)";
        }, 50);

        setTimeout(() => {
          popup.style.opacity = "0";
          popup.style.transform = "translateY(10px)";
          setTimeout(() => popup.remove(), 300);
        }, 1500);
      }

      // ====== Loading Animation Functions ======
      function showLoadingMessage(type = "thinking") {
        removeLoadingMessage();

        const loadingDiv = document.createElement("div");
        loadingDiv.className = "message ai";
        loadingDiv.id = "loading-indicator";

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = "AI";

        const content = document.createElement("div");
        content.className = "message-content loading-content";

        // ========== LOADER UNTUK CHAT (thinking mode) ==========
        if (type === "thinking") {
          content.innerHTML = `<div class="loader"></div>`;
        }
        // ========== LOADER UNTUK VIDEO ==========
        else if (type === "video") {
          content.innerHTML = `
            <div class="video-loading">
              <div class="status-list"></div>
            </div>
          `;
        }

        loadingDiv.appendChild(avatar);
        loadingDiv.appendChild(content);
        chatMessages.appendChild(loadingDiv);

        chatMessages.scrollTo({
          top: chatMessages.scrollHeight,
          behavior: "smooth",
        });
      }

      function addStatusToLoading(text, isComplete = false, isError = false) {
        const loadingIndicator = document.getElementById("loading-indicator");
        if (loadingIndicator) {
          const statusList = loadingIndicator.querySelector(".status-list");

          if (statusList) {
            const statusItem = document.createElement("div");
            statusItem.className = `status-item ${
              isComplete ? "complete" : isError ? "error" : "current"
            }`;

            let icon = "⏳";
            if (isComplete) icon = "✅";
            if (isError) icon = "❌";

            statusItem.innerHTML = `
              <span class="status-icon">${icon}</span>
              <span class="status-text">${text}</span>
            `;
            statusList.appendChild(statusItem);

            chatMessages.scrollTo({
              top: chatMessages.scrollHeight,
              behavior: "smooth",
            });
          }
        }
      }

      function markLastStatusComplete() {
        const loadingIndicator = document.getElementById("loading-indicator");
        if (loadingIndicator) {
          const statusList = loadingIndicator.querySelector(".status-list");
          if (statusList) {
            const currentItems = statusList.querySelectorAll(
              ".status-item.current"
            );
            if (currentItems.length > 0) {
              const lastItem = currentItems[currentItems.length - 1];
              lastItem.classList.remove("current");
              lastItem.classList.add("complete");
              const icon = lastItem.querySelector(".status-icon");
              if (icon) icon.textContent = "✅";
            }
          }
        }
      }

      function updateLoadingProgress(text, progress) {
        const loadingIndicator = document.getElementById("loading-indicator");
        if (loadingIndicator) {
          const loadingText = loadingIndicator.querySelector(".loading-text");
          const progressFill = loadingIndicator.querySelector(
            ".video-progress-fill"
          );

          if (loadingText) loadingText.textContent = text;
          if (progressFill) progressFill.style.width = `${progress}%`;
        }
      }

      function removeLoadingMessage() {
        const existing = document.getElementById("loading-indicator");
        if (existing) existing.remove();
      }

      // Override loading helpers for clearer icons/styles
      function addStatusToLoading(text, isComplete = false, isError = false) {
        const loadingIndicator = document.getElementById("loading-indicator");
        if (!loadingIndicator) return;

        const statusList = loadingIndicator.querySelector(".status-list");
        if (!statusList) return;

        const statusItem = document.createElement("div");
        statusItem.className = `status-item ${
          isComplete ? "complete" : isError ? "error" : "current"
        }`;

        let iconHtml = "";
        if (isError) {
          iconHtml = "!";
        } else if (isComplete) {
          iconHtml = "OK";
        } else {
          // Status sedang berjalan → tampilkan loader-video kecil
          iconHtml = '<span class="loader-video"></span>';
        }

        statusItem.innerHTML = `
          <span class="status-icon">${iconHtml}</span>
          <span class="status-text">${text}</span>
        `;

        statusList.appendChild(statusItem);
        chatMessages.scrollTo({
          top: chatMessages.scrollHeight,
          behavior: "smooth",
        });
      }

      function markLastStatusComplete() {
        const loadingIndicator = document.getElementById("loading-indicator");
        if (!loadingIndicator) return;

        const statusList = loadingIndicator.querySelector(".status-list");
        if (!statusList) return;

        const currentItems = statusList.querySelectorAll(
          ".status-item.current"
        );
        if (!currentItems.length) return;

        const lastItem = currentItems[currentItems.length - 1];
        lastItem.classList.remove("current");
        lastItem.classList.add("complete");
        const icon = lastItem.querySelector(".status-icon");
        if (icon) icon.textContent = "OK";
      }

      // ====== Helpers UI ======
      function showChatUI() {
        welcomeScreen.classList.add("hidden");
        chatMessages.style.display = "block";
      }

      function resetInput() {
        messageInput.value = "";
        messageInput.style.height = "auto";
        sendButton.disabled = true;
      }

      function addMessage(text, sender, videoUrl = null) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = sender === "ai" ? "AI" : "U";

        const content = document.createElement("div");
        content.className = "message-content";

        if (sender === "ai") {
          // Convert Markdown to HTML for AI
          content.innerHTML = marked.parse(text);
        } else {
          // Keep User text plain (safer and cleaner)
          content.textContent = text;
        }

        if (videoUrl) {
          const videoContainer = document.createElement("div");
          videoContainer.style.display = "flex";
          videoContainer.style.flexDirection = "column";
          videoContainer.style.alignItems = "flex-start";
          videoContainer.style.marginTop = "10px";

          const video = document.createElement("video");
          video.controls = true;
          video.src = videoUrl;
          video.style.maxWidth = "100%";
          video.style.borderRadius = "10px";

          // Tentukan nama file download tanpa prefix ID (hanya tanggal_waktu_judul.mp4)
          let fileNamePart = videoUrl.split("/").pop() || `EduGen_${Date.now()}.mp4`;
          // Hilangkan ekstensi untuk proses parsing
          const dotIndex = fileNamePart.lastIndexOf(".");
          const ext = dotIndex !== -1 ? fileNamePart.slice(dotIndex) : ".mp4";
          let baseName = dotIndex !== -1 ? fileNamePart.slice(0, dotIndex) : fileNamePart;

          const segments = baseName.split("_");
          if (segments.length >= 3 && /^\d+$/.test(segments[0]) && /^\d+$/.test(segments[1])) {
            // Pola: <messageId>_<timestamp>_<judul...>
            baseName = segments.slice(1).join("_");
          }
          const fileName = `${baseName}${ext}`;
          const downloadBtn = document.createElement("button");
          downloadBtn.textContent = "Download Video";
          Object.assign(downloadBtn.style, {
            marginTop: "6px",
            fontSize: "13px",
            color: "#DBE2EF",
            background: "#112D4E",
            padding: "6px 10px",
            border: "none",
            borderRadius: "6px",
            cursor: "pointer",
            fontWeight: "bold",
          });

        downloadBtn.onclick = () => {
          const backendUrl = `/learnvid-ai/api/download?url=${encodeURIComponent(videoUrl)}`;
          window.location.href = backendUrl;
        };

          videoContainer.appendChild(video);
          videoContainer.appendChild(downloadBtn);
          content.appendChild(videoContainer);
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(content);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTo({
          top: chatMessages.scrollHeight,
          behavior: "smooth",
        });
      }

      function ensureNotEmptyState() {
        const emptyState =
          document.getElementById("empty-state") ||
          document.querySelector(".chat-item.empty");
        if (emptyState) emptyState.remove();
      }

      function setActiveChatItemById(chatId) {
        document
          .querySelectorAll(".chat-item")
          .forEach((i) => i.classList.remove("active"));
        const node = document.querySelector(
          `.chat-item[data-chat-id="${chatId}"]`
        );
        if (node) node.classList.add("active");
      }

      // ====== API calls ======
      function makeChatTitleFromMessage(message) {
        let text = (message || "").trim();
        if (!text) return "New chat";
        // Batasi panjang judul agar rapi di sidebar
        const maxLen = 60;
        if (text.length > maxLen) {
          text = text.slice(0, maxLen).trim() + "…";
        }
        return text;
      }

      async function createChat(title) {
        const res = await fetch("/learnvid-ai/api/chats", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: CURRENT_USERNAME, title }),
        });
        if (!res.ok) throw new Error("Failed to create chat");
        return res.json();
      }

      async function loadMessages(chatId) {
        const res = await fetch(
          `/learnvid-ai/api/chats/${chatId}/messages?username=${encodeURIComponent(
            CURRENT_USERNAME
          )}`
        );
        if (!res.ok) throw new Error("Failed to load messages");
        const data = await res.json();
        setTimeout(() => {
          chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: "smooth",
          });
        }, 200);
        return data;
      }

      async function postMessage(chatId, content) {
        const res = await fetch(`/learnvid-ai/api/chats/${chatId}/messages`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          // Disesuaikan dengan API Anda
          body: JSON.stringify({
            content: content,
            username: CURRENT_USERNAME,
          }),
        });
        if (!res.ok) throw new Error("Failed to send message");
        return res.json();
      }

      // ====== Event handlers (Chat) ======
      messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
        sendButton.disabled = !this.value.trim();
      });

      let isGenerating = false;

      // Kirim pesan
      async function sendMessage() {
        if (isGenerating) return;
        const message = messageInput.value.trim();
        if (!message) return;

        try {
          isGenerating = true;
          sendButton.disabled = true;
          messageInput.disabled = true;

          if (!activeChatId) {
            // Jika ini chat pertama, buat dulu
            const initialTitle = makeChatTitleFromMessage(message);
            const chat = await createChat(initialTitle);
            activeChatId = chat.id;
            ensureNotEmptyState();
            const node = document.createElement("div");
            node.className = "chat-item active";
            node.dataset.chatId = chat.id;
            node.innerHTML = `
              <span class="chat-title">${escapeHtml(chat.title)}</span>
              <div class="chat-menu">
                <button class="chat-menu-btn" title="Options">
                  <i class="bi bi-three-dots"></i>
                </button>
                <div class="chat-menu-dropdown">
                  <button class="chat-rename">Rename</button>
                  <button class="chat-delete">Delete</button>
                </div>
              </div>
            `;
            // Sisipkan tepat setelah judul "Chats" agar posisi konsisten
            const chatsTitle = chatsSection.querySelector(".chats-title");
            if (chatsTitle && chatsTitle.parentNode === chatsSection) {
              chatsTitle.insertAdjacentElement("afterend", node);
            } else {
              chatsSection.appendChild(node);
            }
            setActiveChatItemById(chat.id);
            updateHeaderTitleFromActiveChat();
            // Update URL tanpa reload
            history.pushState(null, "", `/learnvid-ai/chat?id=${chat.id}`);
          }

          showChatUI();
          addMessage(message, "user");
          const currentChatId = activeChatId; // Simpan ID chat saat ini
          resetInput();
          sendButton.disabled = true;

          if (videoMode) {
            showLoadingMessage("video");
          } else {
            showLoadingMessage("thinking");
          }

          let data;
          if (videoMode) {
            showLoadingMessage("video");
            addStatusToLoading("[ LEARNVIDAI INITIATE ]", false);

            try {
              const res = await fetch(
                `/learnvid-ai/api/chats/${currentChatId}/generate_video`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ topic: message }),
                }
              );

              if (!res.ok) throw new Error("Gagal membuat video");

              const reader = res.body.getReader();
              const decoder = new TextDecoder();

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split("\n");

                for (const line of lines) {
                  if (line.startsWith("data: ")) {
                    const data = JSON.parse(line.slice(6));

                    if (data.status === "completed") {
                      // Mark last status complete and remove loading
                      markLastStatusComplete();
                      setTimeout(() => {
                        removeLoadingMessage();
                        addMessage(data.message, "ai", data.video_url);
                      }, 500);
                    } else if (data.status === "error") {
                      // Don't remove stack on error, just mark as failed
                      markLastStatusComplete();
                      addStatusToLoading(data.message, false, true); // Pass true for isError
                      // Keep the error visible, don't auto-remove
                    } else {
                      // Mark previous status as complete, add new status
                      markLastStatusComplete();
                      addStatusToLoading(data.message, false);
                    }
                  }
                }
              }
            } catch (error) {
              // Keep stack and add error at the end
              markLastStatusComplete();
              addStatusToLoading(`❌ Error: ${error.message}`, false);
            }
          } else {
            data = await postMessage(currentChatId, message);
            removeLoadingMessage();
            addMessage(
              // data.ai_message.content,
              marked.parse(data.ai_message.content),
              "ai",
              data.ai_message.video_url
            );
          }

          // Rename chat item jika ini pesan pertama (hanya mode chat teks)
          if (!videoMode && data && data.new_title) {
            const chatItem = document.querySelector(
              `.chat-item[data-chat-id="${currentChatId}"] .chat-title`
            );
            if (chatItem) {
              chatItem.textContent = data.new_title;
            }
          }
        } catch (err) {
          removeLoadingMessage();
          console.error(err);
          addMessage("❌ Maaf, terjadi kesalahan. Coba lagi nanti.", "ai");
        } finally {
          isGenerating = false;
          messageInput.disabled = false;
          sendButton.disabled = !messageInput.value.trim();
        }
      }

      if (sendButton) {
        sendButton.addEventListener("click", sendMessage);
      }
      if (messageInput) {
        messageInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }

      // Auto-load pesan untuk chat yang sudah active
      (async function initAutoLoadActive() {
        if (activeChatId) {
          try {
            const msgs = await loadMessages(activeChatId);
            ensureNotEmptyState();
            chatMessages.innerHTML = "";
            showChatUI();
            msgs.forEach((m) => addMessage(m.content, m.role, m.video_url));
            setTimeout(() => {
              chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: "smooth",
              });
            }, 300);
            updateHeaderTitleFromActiveChat();
          } catch (e) {
            console.warn("No initial messages loaded:", e);
            welcomeScreen.classList.remove("hidden"); // Tampilkan welcome screen jika gagal load
            updateHeaderTitleFromActiveChat();
          }
        } else {
          // Tidak ada chat aktif, pastikan welcome screen terlihat
          welcomeScreen.classList.remove("hidden");
          chatMessages.style.display = "none";
          updateHeaderTitleFromActiveChat();
        }
      })();

      // ====== Event Handlers (Sidebar) ======

      // Klik chat-item
      if (chatsSection) {
        chatsSection.addEventListener("click", async function (e) {
          const target = e.target.closest(".chat-item");
          if (
            !target ||
            target.classList.contains("empty") ||
            e.target.closest(".chat-menu-btn")
          ) {
            return;
          }

          try {
            const chatId = target.dataset.chatId;
            if (!chatId || chatId === activeChatId) return; // Jangan reload jika chat sudah aktif

            // Hanya izinkan satu yang aktif: hapus dari menu & chat items
            document
              .querySelectorAll(".sidebar-menu .menu-item")
              .forEach((i) => i.classList.remove("active"));
            document
              .querySelectorAll(".chat-item")
              .forEach((i) => i.classList.remove("active"));
            target.classList.add("active");
            activeChatId = chatId;
            updateHeaderTitleFromActiveChat();

            // Update URL
            history.pushState(null, "", `/learnvid-ai/chat?id=${chatId}`);

            const msgs = await loadMessages(chatId);
            ensureNotEmptyState();
            chatMessages.innerHTML = "";
            showChatUI();
            msgs.forEach((m) => addMessage(m.content, m.role, m.video_url));
            closeMobileSidebar();
          } catch (err) {
            console.error(err);
            alert("Failed to load messages");
          }
        });
      }

      // Tombol "New Chat" di sidebar
      const sidebarNewChat = document.querySelector(
        '.sidebar-menu .menu-item[href="/learnvid-ai/chat"]'
      );
      if (sidebarNewChat) {
        sidebarNewChat.addEventListener("click", (e) => {
          e.preventDefault();

          // Hapus status aktif dari menu & chat items
          document
            .querySelectorAll(".sidebar-menu .menu-item")
            .forEach((i) => i.classList.remove("active"));
          document
            .querySelectorAll(".chat-item")
            .forEach((i) => i.classList.remove("active"));

          // Tandai New Chat sebagai aktif
          sidebarNewChat.classList.add("active");

          // Belum ada chat yang dipilih/dibuat
          activeChatId = null;

          // Header kembali ke default
          updateHeaderTitleFromActiveChat();

          // Reset tampilan: kembali ke welcome screen, belum ada chat di sidebar yang baru
          chatMessages.innerHTML = "";
          chatMessages.style.display = "none";
          welcomeScreen.classList.remove("hidden");
          resetInput();

          // URL tanpa id, supaya sendMessage nanti buat chat baru
          history.pushState(null, "", "/learnvid-ai/chat");
          closeMobileSidebar();
        });
      }

      function updateMessage(messageId, content) {
        const msgElement = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (msgElement) {
          msgElement.querySelector(".message-content").textContent = content;
        }
      }

      // Chat menu: toggle, rename, delete
      function closeAllChatMenus(except) {
        document.querySelectorAll(".chat-menu").forEach((m) => {
          if (m !== except) m.classList.remove("open");
        });
      }

      function removeMessage(messageId) {
        const msgElement = document.querySelector(
          `[data-message-id="${messageId}"]`
        );
        if (msgElement) msgElement.remove();
      }

      chatsSection.addEventListener("click", (e) => {
        const btn = e.target.closest(".chat-menu-btn");
        if (!btn) return;
        e.stopPropagation();
        const menu = btn.closest(".chat-menu");
        const isOpen = menu.classList.contains("open");
        closeAllChatMenus(menu);
        if (!isOpen) menu.classList.add("open");
      });

      document.addEventListener("click", () => closeAllChatMenus(null));

      // Handler RENAME
      chatsSection.addEventListener("click", async (e) => {
        const btn = e.target.closest(".chat-rename");
        if (!btn) return;

        e.stopPropagation();
        const item = btn.closest(".chat-item");
        const chatId = item?.dataset?.chatId;
        if (!chatId) return;

        const titleSpan = item.querySelector(".chat-title");
        const currentTitle = titleSpan?.textContent?.trim() || "Untitled";

        const newTitle = await openModal({
          title: "✏️ Rename Chat",
          placeholder: "Enter new title...",
          defaultValue: currentTitle,
        });
        if (newTitle === null) return;
        const cleaned = (newTitle || "").trim();
        if (!cleaned || cleaned === currentTitle) return;

        try {
          const res = await fetch(`/learnvid-ai/api/chats/${chatId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: cleaned }),
          });
          if (!res.ok) throw new Error("Rename failed");
          const data = await res.json();

          titleSpan.textContent = data.title;
          if (chatId === activeChatId) {
            updateHeaderTitleFromActiveChat();
          }
          closeAllChatMenus(null);
        } catch (err) {
          console.error(err);
          alert("Failed to rename chat");
        }
      });

      // Handler DELETE
      chatsSection.addEventListener("click", async (e) => {
        const btn = e.target.closest(".chat-delete");
        if (!btn) return;

        e.stopPropagation();
        const item = btn.closest(".chat-item");
        const chatId = item?.dataset?.chatId;
        if (!chatId) return;

        const confirmDelete = await openModal({
          title: "Delete Chat",
          message: "This action cannot be undone!",
          icon: "https://cdn-icons-png.flaticon.com/512/1214/1214428.png",
          isConfirm: true,
        });
        if (!confirmDelete) return;

        try {
          const res = await fetch(`/learnvid-ai/api/chats/${chatId}`, { method: "DELETE" });
          if (!res.ok) throw new Error("Delete failed");

          const deletingActive = item.classList.contains("active");
          item.remove();

          if (!document.querySelector(".chat-item[data-chat-id]")) {
            const placeholder = document.createElement("div");
            placeholder.id = "empty-state";
            placeholder.className = "chat-item empty";
            placeholder.textContent = "No chats yet";
            chatsSection.appendChild(placeholder);
          }

          if (deletingActive) {
            // Jika chat yang aktif dihapus, reset ke welcome screen
            chatMessages.innerHTML = "";
            chatMessages.style.display = "none";
            welcomeScreen.classList.remove("hidden");
            activeChatId = null;
            history.pushState(null, "", "/learnvid-ai/chat");

            // Opsional: aktifkan chat pertama jika ada
            const first = document.querySelector(".chat-item[data-chat-id]");
            if (first) {
              first.click(); // Simulasikan klik untuk memuat chat pertama
            } else {
              updateHeaderTitleFromActiveChat();
            }
          }
          closeAllChatMenus(null);
        } catch (err) {
          console.error(err);
          alert("Failed to delete chat");
        }
      });

      // Toggle Mode: Buat Video
      const uploadBtnEl = document.getElementById("upload-btn");
      const videoStateEl = document.getElementById("video-state");
      const videoStateLabel = videoStateEl?.querySelector(
        ".video-state-label"
      );
      if (uploadBtnEl) {
        let bubbleTimeout = null;
        let stateTimeout = null;

        function showVideoState(isOn) {
          if (!videoStateEl || !videoStateLabel) return;
          if (!window.matchMedia("(max-width: 600px)").matches) return;

          videoStateEl.classList.toggle("on", isOn);
          videoStateLabel.textContent = isOn
            ? "Video mode on"
            : "Video mode off";
          videoStateEl.classList.add("show");

          clearTimeout(stateTimeout);
          stateTimeout = setTimeout(() => {
            videoStateEl.classList.remove("show");
          }, 1600);
        }

        function showToggleBubble(msg) {
          const isMobile = window.matchMedia("(max-width: 600px)").matches;
          if (isMobile) {
            showVideoState(videoMode);
            return;
          }

          let bubble = uploadBtnEl.querySelector(".upload-btn-bubble");
          if (!bubble) {
            bubble = document.createElement("div");
            bubble.className = "upload-btn-bubble";
            uploadBtnEl.appendChild(bubble);
          }

          bubble.textContent = msg;
          bubble.style.opacity = "1";
          bubble.style.position = "absolute";
          bubble.style.left = "50%";
          bubble.style.right = "auto";
          bubble.style.whiteSpace = "nowrap";
          bubble.style.textAlign = "center";
          bubble.style.overflowWrap = "";
          bubble.style.wordBreak = "";
          bubble.style.maxWidth = "none";
          bubble.style.minWidth = "";
          bubble.style.transform = "translate(-50%, -4px)";
          bubble.style.top = "";
          bubble.style.bottom = "";
          bubble.style.width = "";

          clearTimeout(bubbleTimeout);
          bubbleTimeout = setTimeout(() => {
            bubble.style.opacity = "0";
            bubble.style.transform = "translate(-50%, 0)";
          }, 1400);
        }

        uploadBtnEl.addEventListener("click", () => {
          videoMode = !videoMode;
          uploadBtnEl.classList.toggle("active", videoMode);

          if (videoMode) {
            uploadBtnEl.title = "Video mode is ON (click to turn off)";
            showToggleBubble("Video mode on");
          } else {
            uploadBtnEl.title = "Video mode is OFF (click to turn on)";
            showToggleBubble("Video mode off");
          }
        });
      }

      // Modal Helper
      function openModal({
        title,
        message = "",
        icon = "",
        placeholder = "",
        defaultValue = "",
        isConfirm = false,
      }) {
        return new Promise((resolve) => {
          const overlay = document.getElementById("modal-overlay");
          const titleEl = document.getElementById("modal-title");
          const msgEl = document.getElementById("modal-message");
          const iconEl = document.getElementById("modal-icon");
          const inputEl = document.getElementById("modal-input");
          const okBtn = document.getElementById("modal-ok");
          const cancelBtn = document.getElementById("modal-cancel");

          titleEl.textContent = title;
          msgEl.textContent = message;
          iconEl.src = icon || "";
          iconEl.style.display = icon ? "block" : "none";
          inputEl.style.display = isConfirm ? "none" : "block";
          inputEl.placeholder = placeholder;
          inputEl.value = defaultValue;

          overlay.style.display = "flex";
          if (!isConfirm) inputEl.focus();

          function closeModal(value) {
            overlay.style.display = "none";
            okBtn.removeEventListener("click", onOk);
            cancelBtn.removeEventListener("click", onCancel);
            inputEl.removeEventListener("keydown", onEnter);
            resolve(value);
          }

          function onOk() {
            const val = isConfirm ? true : inputEl.value.trim();
            closeModal(val || null);
          }
          function onCancel() {
            closeModal(null);
          }
          function onEnter(e) {
            if (e.key === "Enter") onOk();
          }

          okBtn.addEventListener("click", onOk);
          cancelBtn.addEventListener("click", onCancel);
          inputEl.addEventListener("keydown", onEnter);
        });
      }
    </script>
  </body>
</html>
