<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnVid AI - Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Montaga&display=swap" rel="stylesheet">
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/3.0.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Costaline:wght@400&display=swap');

  /* Reset */
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Montaga', serif;
    background: #F9F7F7;
    color: #112D4E;
    height: 100vh;
    overflow: hidden;
  }

  .container { display: flex; height: 100vh; }

  /* Sidebar */
  .sidebar {
    width: 260px;
    background: #112D4E;
    color: #F9F7F7;
    display: flex;
    flex-direction: column;
    border-right: 1px solid rgba(219, 226, 239, 0.1);
  }
  .sidebar-header { padding: 16px 12px; }

  .new-chat-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 12px; width: 100%;
    background: transparent;
    border: 1px solid rgba(219, 226, 239, 0.2);
    border-radius: 8px;
    color: #F9F7F7; cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Montaga', serif; font-size: 14px;
  }
  .new-chat-btn:hover { background: rgba(219, 226, 239, 0.1); }
  .new-chat-btn svg { width: 16px; height: 16px; }

  .sidebar-menu { padding: 8px 12px; flex: 1; overflow-y: auto; }

  .menu-item search-row{
    display: flex; align-items: center; gap: 10px;
    padding: 8px 12px; margin-bottom: 2px;
    color: #DBE2EF; border-radius: 6px;
    cursor: pointer; transition: all 0.2s ease; font-size: 14px;
  }
  /* .menu-item:hover { background: rgba(219, 226, 239, 0.1); } */
  .menu-item svg { width: 16px; height: 16px; }


  .chats-section { margin-top: 20px; }
  .chats-title {
    color: #DBE2EF; font-size: 11px; opacity: .7;
    text-transform: uppercase; letter-spacing: .5px;
    margin-bottom: 8px; padding: 0 12px;
  }

  /* Chat items + menu (ellipsis, dropdown) */
  .chat-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; margin-bottom: 2px; position: relative;
    color: #DBE2EF; border-radius: 6px; cursor: pointer;
    transition: all 0.2s ease; font-size: 14px; line-height: 1.4;
  }
  .chat-item:hover { background: rgba(219, 226, 239, 0.1); }
  .chat-item.active { background: #3F72AF; color: #F9F7F7; }

  .chat-title {
    flex: 1; margin-right: 8px; max-width: 180px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    display: inline-block; vertical-align: middle;
  }

  .chat-menu { position: relative; }
  .chat-menu-btn {
    background: none; border: none; cursor: pointer;
    font-size: 16px; color: #666; display: inline-flex; align-items: center;
  }
  .fi-rr-file-edit { color: #fff; } /* ikon edit putih di sidebar gelap */

  .chat-menu-dropdown {
    display: none; position: absolute; right: 0; top: 100%;
    background: #fff; border: 1px solid #ddd; border-radius: 6px;
    padding: 4px 0; min-width: 120px; z-index: 10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .chat-menu.open .chat-menu-dropdown { display: block; }
  .chat-menu-dropdown button {
    display: block; width: 100%; padding: 8px 12px;
    background: none; border: none; text-align: left;
    cursor: pointer; font-size: 14px; color: #112D4E;
  }
  .chat-menu-dropdown button:hover { background: #f3f3f3; }

  .sidebar-footer {
    padding: 12px; border-top: 1px solid rgba(219, 226, 239, 0.1);
  }
  .user-info {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: .2s;
  }
  .user-info:hover { background: rgba(219, 226, 239, 0.1); }
  .user-avatar {
    width: 24px; height: 24px; border-radius: 50%;
    background: #3F72AF; display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: bold;
  }
  .username { color: #DBE2EF; font-size: 14px; }

  /* Main Chat Area */
  .chat-main { flex: 1; display: flex; flex-direction: column; background: #F9F7F7; }
  .chat-header {
    padding: 12px 16px; background: #F9F7F7;
    border-bottom: 1px solid rgba(17, 45, 78, 0.1);
    display: flex; align-items: center; justify-content: space-between;
  }
  .chat-header .chat-title { /* judul header app */
    font-family: 'Costaline', cursive; font-size: 1.1rem; color: #112D4E;
    max-width: none; white-space: normal; overflow: visible; text-overflow: clip;
  }
  .chat-actions { display: flex; gap: 8px; }
  .action-btn {
    padding: 6px 12px; background: transparent;
    border: 1px solid rgba(17, 45, 78, 0.2);
    border-radius: 6px; color: #3F72AF; cursor: pointer; transition: .2s; font-size: 12px;
  }
  .action-btn:hover { background: rgba(63, 114, 175, 0.1); color: #112D4E; }

  .chat-container { flex: 1; display: flex; flex-direction: column; overflow-y: auto; position: relative; background: #F9F7F7; }

  .welcome-screen {
    flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
    text-align: center; padding: 40px;
  }
  .welcome-screen.hidden { display: none; }
  .welcome-title { font-family: 'Costaline', cursive; font-size: 2.5rem; color: #112D4E; margin-bottom: 15px; }
  .welcome-subtitle { color: #3F72AF; font-size: 1.2rem; opacity: .9; }

  .chat-messages { flex: 1; padding: 20px; display: none; overflow-y: auto; }

  .message {
    margin-bottom: 24px; display: flex; align-items: flex-start; gap: 12px;
    max-width: 800px; margin-left: auto; margin-right: auto;
  }
  .message.user { flex-direction: row-reverse; }

  .message-avatar {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0;
  }
  .message.ai .message-avatar { background: #3F72AF; color: #F9F7F7; }
  .message.user .message-avatar { background: #DBE2EF; color: #112D4E; }

  .message-content {
    max-width: 70%; padding: 16px 20px; border-radius: 18px; font-size: 14px; line-height: 1.5; position: relative;
  }
  .message.ai .message-content { background: #3F72AF; color: #F9F7F7; border-bottom-left-radius: 6px; }
  .message.user .message-content { background: #DBE2EF; color: #112D4E; border-bottom-right-radius: 6px; }

  /* Input Area */
  .input-area { padding: 20px; background: #F9F7F7; }
  .input-container {
    max-width: 800px; margin: 0 auto; position: relative;
    background: #F9F7F7; border-radius: 24px; border: 2px solid #DBE2EF;
    display: flex; align-items: flex-end; min-height: 52px; transition: .3s;
  }
  .input-container:focus-within { border-color: #3F72AF; box-shadow: 0 0 0 3px rgba(63, 114, 175, 0.1); }

  .upload-btn {
    padding: 12px; margin: 4px;
    background: transparent; border: none; cursor: pointer; color: #3F72AF;
    display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: .2s; position: relative;
  }
  .upload-btn:hover { background: rgba(63, 114, 175, 0.1); color: #112D4E; }
  .upload-btn svg { width: 20px; height: 20px; }

  .upload-dropdown {
    position: absolute; bottom: 100%; left: 0; margin-bottom: 8px;
    background: #F9F7F7; border: 2px solid #DBE2EF; border-radius: 8px;
    min-width: 200px; display: none; z-index: 1000;
    box-shadow: 0 4px 20px rgba(17, 45, 78, 0.1);
  }
  .upload-dropdown.show { display: block; }

  .upload-option {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px; border-bottom: 1px solid #DBE2EF;
    color: #112D4E; cursor: pointer; transition: .2s; font-size: 14px;
  }
  .upload-option:last-child { border-bottom: none; }
  .upload-option:hover { background: rgba(63, 114, 175, 0.1); color: #112D4E; }
  .upload-option svg { width: 16px; height: 16px; color: #3F72AF; }

  .message-input {
    flex: 1; padding: 12px 16px; min-height: 24px; max-height: 120px;
    border: none; background: transparent; outline: none; resize: none;
    font-family: 'Montaga', serif; font-size: 15px; color: #112D4E; line-height: 1.5;
  }
  .message-input::placeholder { color: #3F72AF; opacity: .7; }

  .send-button {
    padding: 12px; margin: 4px; background: transparent; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: .2s;
  }
  .send-button:disabled { opacity: .4; cursor: not-allowed; }
  .send-button:not(:disabled):hover { background: rgba(63, 114, 175, 0.1); }
  .send-button svg { width: 20px; height: 20px; color: #3F72AF; }
  .send-button:not(:disabled) svg { color: #3F72AF; }

  /* Hidden file inputs */
  .file-input { display: none; }

  /* Mobile */
  @media (max-width: 768px) {
    .sidebar { width: 240px; }
    .welcome-title { font-size: 1.5rem; }
    .input-area { padding: 16px; }
    .chat-messages { padding: 16px; }
  }

  .search-row {
  gap: 8px;
}
.search-input {
  flex: 1;
  background: rgba(219,226,239,0.08);
  border: 1px solid rgba(219,226,239,0.2);
  color: #F9F7F7;
  border-radius: 6px;
  padding: 6px 28px 6px 8px;
  font-size: 13px;
  outline: none;
}
.search-input::placeholder { color: rgba(219,226,239,0.7); }
.search-input:focus {
  border-color: rgba(219,226,239,0.45);
  background: rgba(219,226,239,0.12);
}
.search-clear{
  position: relative;
  right: 28px;
  background: transparent;
  border: none;
  color: rgba(219,226,239,0.8);
  cursor: pointer;
  font-size: 14px;
  padding: 0 6px;
  display: none;
}
.search-clear.show { display: inline; }
</style>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="new-chat-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 4.5v15m7.5-7.5h-15"/>
                    </svg>
                    New chat
                </button>
            </div>

            <div class="sidebar-menu">
                <div class="menu-item search-row">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
                </svg>
                <input id="chat-search" class="search-input" type="text" placeholder="Search chats..." autocomplete="off"/>
                <button id="chat-search-clear" class="search-clear" aria-label="Clear">✕</button>
                </div>

                <div class="menu-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
                    </svg>
                    Library
                </div>

                <div class="chats-section" id="chats-section">
                <div class="chats-title">Your Chats</div>
                {% if chats and chats|length > 0 %}
                    {% for c in chats %}
                    <div class="chat-item{% if loop.first %} active{% endif %}" data-chat-id="{{ c.id }}">
                        <span class="chat-title">{{ c.title }}</span>
                        <div class="chat-menu">
                        <button class="chat-menu-btn" title="Options"><i class="fi fi-rr-file-edit"></i></button>
                        <div class="chat-menu-dropdown">
                            <button class="chat-rename">Rename</button>
                            <button class="chat-delete">Delete</button>
                        </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div id="empty-state" class="chat-item empty">No chats yet</div>
                {% endif %}
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div class="username">{{username}}</div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-title">LearnVid AI</div>
                <div class="chat-actions">
                    <!-- <button href="/logout" class="action-btn">Log Out</button> -->
                    <!-- <button class="action-btn">⋯</button> -->
                     <a href="/logout" class="action-btn">Log out</a>
                </div>
            </div>

            <div class="chat-container">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcome-screen">
                    <h1 class="welcome-title">Welcome, {{username}}!</h1>
                    <p class="welcome-subtitle">What should we learn today?</p>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chat-messages">
                    <!-- Messages will be dynamically added here -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <div class="upload-btn" id="upload-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 4.5v15m7.5-7.5h-15"/>
                        </svg>
                        <div class="upload-dropdown" id="upload-dropdown">
                            <div class="upload-option" onclick="triggerFileUpload('image')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="9" cy="9" r="2"/>
                                    <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                                </svg>
                                Upload Image
                            </div>
                            <div class="upload-option" onclick="triggerFileUpload('document')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                                    <polyline points="14,2 14,8 20,8"/>
                                </svg>
                                Upload Document
                            </div>
                            <div class="upload-option" onclick="triggerFileUpload('video')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <polygon points="23 7 16 12 23 17 23 7"/>
                                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                                </svg>
                                Upload Video
                            </div>
                        </div>
                    </div>

                    <textarea class="message-input" id="message-input" placeholder="Ask anything" rows="1"></textarea>

                    <button class="send-button" id="send-button" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M22 2L11 13"/>
                            <path d="M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="image-upload" class="file-input" accept="image/*">
    <input type="file" id="document-upload" class="file-input" accept=".pdf,.doc,.docx,.txt">
    <input type="file" id="video-upload" class="file-input" accept="video/*">




<script>
  // ====== User context dari Jinja ======
  const CURRENT_USERNAME = "{{ username }}";

  // ====== Elemen DOM ======
  const messageInput   = document.getElementById('message-input');
  const sendButton     = document.getElementById('send-button');
  const chatMessages   = document.getElementById('chat-messages');
  const welcomeScreen  = document.getElementById('welcome-screen');
  const newChatBtn     = document.getElementById('new-chat-btn');
  const uploadBtn      = document.getElementById('upload-btn');
  const uploadDropdown = document.getElementById('upload-dropdown');
  const chatsSection   = document.querySelector('.chats-section');

  // File inputs (opsional)
  const imageUpload    = document.getElementById('image-upload');
  const documentUpload = document.getElementById('document-upload');
  const videoUpload    = document.getElementById('video-upload');

  // ====== State ======
  let chatStarted  = false;
  let activeChatId = (() => {
    const firstActive = document.querySelector('.chat-item.active');
    return firstActive ? (firstActive.dataset.chatId || null) : null;
  })();

  // ====== Helpers UI ======
  function showChatUI() {
    welcomeScreen.classList.add('hidden');
    chatMessages.style.display = 'block';
    chatStarted = true;
  }

  function resetInput() {
    messageInput.value = '';
    messageInput.style.height = 'auto';
    sendButton.disabled = true;
  }

  function addMessage(text, sender, videoUrl = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;

    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = sender === 'ai' ? 'AI' : 'U';

    const content = document.createElement('div');
    content.className = 'message-content';
    content.innerHTML = text;

    // 🎬 kalau ada video_url → tambahkan video player di bawah teks
    if (videoUrl) {
      const video = document.createElement('video');
      video.controls = true;
      video.src = videoUrl;
      video.style.maxWidth = '100%';
      video.style.borderRadius = '10px';
      video.style.marginTop = '10px';
      content.appendChild(video);
    }

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function ensureNotEmptyState() {
    // hapus placeholder "No chats yet" jika ada
    const emptyState = document.getElementById('empty-state') || document.querySelector('.chat-item.empty');
    if (emptyState) emptyState.remove();
  }

  function setActiveChatItemById(chatId) {
    document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
    const node = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
    if (node) node.classList.add('active');
  }

  // ====== API calls ======
  async function createChat(title) {
    const res = await fetch('/api/chats', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: CURRENT_USERNAME, title })
    });
    if (!res.ok) throw new Error('Failed to create chat');
    return res.json(); // { id, title }
  }

  async function loadMessages(chatId) {
    const res = await fetch(`/api/chats/${chatId}/messages?username=${encodeURIComponent(CURRENT_USERNAME)}`);
    if (!res.ok) throw new Error('Failed to load messages');
    return res.json(); // [{id, role, content, timestamp}, ...]
  }

  async function refreshMessages(chatId) {
    try {
      const msgs = await loadMessages(chatId);
      chatMessages.innerHTML = '';
      msgs.forEach(m => addMessage(m.content, m.role, m.video_url));
    } catch (e) {
      console.warn("refreshMessages error:", e);
    }
  }

  async function postMessage(chatId, content) {
    const res = await fetch(`/api/chats/${chatId}/messages`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: CURRENT_USERNAME, content })
    });
    if (!res.ok) throw new Error('Failed to send message');
    return res.json(); // { ok, user_message, ai_message }
  }

  // ====== Event handlers ======
  // Auto-resize + enable/disable send
  messageInput.addEventListener('input', function () {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    sendButton.disabled = !this.value.trim();
  });

  // Upload dropdown toggle
  if (uploadBtn && uploadDropdown) {
    uploadBtn.addEventListener('click', function () {
      uploadDropdown.classList.toggle('show');
    });

    // Close dropdown ketika klik di luar
    document.addEventListener('click', function (e) {
      if (!uploadBtn.contains(e.target) && !uploadDropdown.contains(e.target)) {
        uploadDropdown.classList.remove('show');
      }
    });
  }

  // Trigger file uploads (opsional)
  function triggerFileUpload(type) {
    const fileInput = document.getElementById(type + '-upload');
    if (fileInput) {
      fileInput.click();
      if (uploadDropdown) uploadDropdown.classList.remove('show');
    }
  }
  window.triggerFileUpload = triggerFileUpload;

  // File uploads UI feedback (opsional)
  [imageUpload, documentUpload, videoUpload].forEach(input => {
    if (!input) return;
    input.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        addMessage(`📎 Uploaded: ${file.name}`, 'user');
        setTimeout(() => addMessage(`I can see you've uploaded a file. How can I help you with it?`, 'ai'), 800);
      }
    });
  });

  // New chat
  if (newChatBtn) {
    newChatBtn.addEventListener('click', async function (e) {
      e.preventDefault();
      try {
        const title = prompt('Chat title:', 'New chat');
        if (title === null) return;

        const chat = await createChat((title || 'New chat').trim() || 'New chat');
        activeChatId = chat.id;

        // Tambahkan ke sidebar & set active
        ensureNotEmptyState();
        document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));

        const node = document.createElement('div');
        node.className = 'chat-item active';
        node.dataset.chatId = chat.id;
        node.textContent = chat.title;
        chatsSection.appendChild(node);

        // tampilkan UI chat kosong
        chatMessages.innerHTML = '';
        showChatUI();
      } catch (err) {
        console.error(err);
        alert('Failed to create chat');
      }
    });
  }

  // Delegasi klik chat-item (termasuk yang baru dibuat)
  if (chatsSection) {
    chatsSection.addEventListener('click', async function (e) {
      const target = e.target.closest('.chat-item');
      if (!target || target.classList.contains('empty')) return;

      try {
        const chatId = target.dataset.chatId;
        if (!chatId) return;

        // set active
        document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
        target.classList.add('active');
        activeChatId = chatId;

        // load messages
        const msgs = await loadMessages(chatId);
        ensureNotEmptyState();
        chatMessages.innerHTML = '';
        showChatUI();
        msgs.forEach(m => addMessage(m.content, m.role, m.video_url)); // ✅ kirim URL video
      } catch (err) {
        console.error(err);
        alert('Failed to load messages');
      }
    });
  }

  // Kirim pesan
  async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    // === tampilkan pesan user langsung, tanpa tunggu server ===
    showChatUI();
    addMessage(message, 'user');
    resetInput();
    sendButton.disabled = true;

    try {
      // Jika belum ada chat aktif → buat dulu
      if (!activeChatId) {
        const title = message.slice(0, 40) || 'New chat';
        const chat = await createChat(title);
        activeChatId = chat.id;

        ensureNotEmptyState();
        document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));

        const node = document.createElement('div');
        node.className = 'chat-item active';
        node.dataset.chatId = chat.id;
        node.textContent = chat.title;
        chatsSection.appendChild(node);
      }

      // === kirim pesan ke server ===
      const data = await postMessage(activeChatId, message);

      // tampilkan respon AI (misal "🎬 Generating...")
      addMessage(data.ai_message.content, 'ai', data.ai_message.video_url);

      // Polling untuk update video otomatis
      if (data.ai_message.content.includes("Generating")) {
        let retries = 0;
        const interval = setInterval(async () => {
          retries++;
          const msgs = await loadMessages(activeChatId);
          const hasVideo = msgs.some(m => m.video_url && m.video_url.length > 0);
          if (hasVideo || retries > 60) { // maksimal 3 menit
            clearInterval(interval);
            chatMessages.innerHTML = '';
            msgs.forEach(m => addMessage(m.content, m.role, m.video_url));
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }, 3000);
      }
    } catch (err) {
      console.error(err);
      alert('Failed to send message');
    } finally {
      sendButton.disabled = false;
    }
  }

  if (sendButton) {
    sendButton.addEventListener('click', sendMessage);
  }
  if (messageInput) {
    messageInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  }

  // ====== Optional: auto-load pesan untuk chat yang sudah active saat render ======
  (async function initAutoLoadActive() {
    const firstActive = document.querySelector('.chat-item.active');
    if (firstActive && firstActive.dataset.chatId) {
      try {
        const msgs = await loadMessages(firstActive.dataset.chatId);
        ensureNotEmptyState();
        chatMessages.innerHTML = '';
        showChatUI();
        msgs.forEach(m => addMessage(m.content, m.role, m.video_url)); // ✅ tambahkan video
        activeChatId = firstActive.dataset.chatId;
      } catch (e) {
        console.warn('No initial messages loaded:', e);
      }
    }
  })();

//   ------
// ===== Chat menu: toggle, rename, delete =====
function closeAllChatMenus(except) {
  document.querySelectorAll('.chat-menu').forEach(m => {
    if (m !== except) m.classList.remove('open');
  });
}

// Buka/tutup dropdown saat klik ikon pensil
chatsSection.addEventListener('click', (e) => {
  const btn = e.target.closest('.chat-menu-btn');
  if (!btn) return;
  e.stopPropagation();
  const menu = btn.closest('.chat-menu');
  const isOpen = menu.classList.contains('open');
  closeAllChatMenus(menu);
  if (!isOpen) menu.classList.add('open');
});

// Tutup dropdown kalau klik di luar
document.addEventListener('click', () => closeAllChatMenus(null));

// Handler RENAME
chatsSection.addEventListener('click', async (e) => {
  const btn = e.target.closest('.chat-rename');
  if (!btn) return;

  e.stopPropagation();
  const item = btn.closest('.chat-item');
  const chatId = item?.dataset?.chatId;
  if (!chatId) return;

  const titleSpan = item.querySelector('.chat-title');
  const currentTitle = titleSpan?.textContent?.trim() || 'Untitled';

  const newTitle = prompt('Rename chat:', currentTitle);
  if (newTitle === null) return;               // user cancel
  const cleaned = (newTitle || '').trim();
  if (!cleaned || cleaned === currentTitle) {  // kosong/ tidak berubah
    return;
  }

  try {
    // PATCH ke backend
    const res = await fetch(`/api/chats/${chatId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title: cleaned })
    });
    if (!res.ok) throw new Error('Rename failed');
    const data = await res.json();

    // Update UI (ellipsis tetap jalan via CSS .chat-title)
    titleSpan.textContent = data.title;

    // Kalau chat ini sedang aktif & kamu punya header judul lain, bisa ikut di-update:
    // document.querySelector('.chat-header .chat-title')?.textContent = data.title;

    // Tutup dropdown
    closeAllChatMenus(null);
  } catch (err) {
    console.error(err);
    alert('Failed to rename chat');
  }
});

// Handler DELETE
chatsSection.addEventListener('click', async (e) => {
  const btn = e.target.closest('.chat-delete');
  if (!btn) return;

  e.stopPropagation();
  const item = btn.closest('.chat-item');
  const chatId = item?.dataset?.chatId;
  if (!chatId) return;

  if (!confirm('Delete this chat? This action cannot be undone.')) return;

  try {
    const res = await fetch(`/api/chats/${chatId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('Delete failed');

    // Jika chat yang dihapus sedang aktif, reset area chat
    const deletingActive = item.classList.contains('active');
    item.remove();

    // Jika tidak ada chat lagi → tampilkan placeholder
    if (!document.querySelector('.chat-item')) {
      const placeholder = document.createElement('div');
      placeholder.id = 'empty-state';
      placeholder.className = 'chat-item empty';
      placeholder.textContent = 'No chats yet';
      chatsSection.appendChild(placeholder);
    }

    if (deletingActive) {
      // Kosongkan messages & tampilkan welcome
      chatMessages.innerHTML = '';
      chatMessages.style.display = 'none';
      welcomeScreen.classList.remove('hidden');
      activeChatId = null;

      // Optional: aktifkan chat pertama yang tersisa
      const first = document.querySelector('.chat-item[data-chat-id]');
      if (first) {
        first.classList.add('active');
        activeChatId = first.dataset.chatId;
        try {
          const msgs = await loadMessages(activeChatId);
          chatMessages.innerHTML = '';
          showChatUI();
          msgs.forEach(m => addMessage(m.content, m.role));
        } catch {}
      }
    }

    // Tutup dropdown
    closeAllChatMenus(null);
  } catch (err) {
    console.error(err);
    alert('Failed to delete chat');
  }
});

// ====== Search chats ======
const chatSearchInput = document.getElementById('chat-search');
const chatSearchClear = document.getElementById('chat-search-clear');

function renderChatList(chats) {
  const container = document.getElementById('chats-section');
  if (!container) return;

  // Bangun ulang daftar
  const titleHtml = '<div class="chats-title">Your Chats</div>';
  let listHtml = '';
  if (chats.length === 0) {
    listHtml = '<div id="empty-state" class="chat-item empty">No chats yet</div>';
  } else {
    listHtml = chats.map((c, i) => `
      <div class="chat-item${(activeChatId && String(activeChatId)===String(c.id)) ? ' active' : ''}" data-chat-id="${c.id}">
        <span class="chat-title">${escapeHtml(c.title)}</span>
        <div class="chat-menu">
          <button class="chat-menu-btn" title="Options"><i class="fi fi-rr-file-edit"></i></button>
          <div class="chat-menu-dropdown">
            <button class="chat-rename">Rename</button>
            <button class="chat-delete">Delete</button>
          </div>
        </div>
      </div>
    `).join('');
  }
  container.innerHTML = titleHtml + listHtml;
}

// simple escaper biar aman
function escapeHtml(str=''){
  return str.replace(/[&<>"']/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[s]));
}

// debounce helper
function debounce(fn, ms=250){
  let t; 
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), ms);
  };
}

async function fetchSearchResults(query){
  const url = '/api/chats/search?q=' + encodeURIComponent(query || '');
  const res = await fetch(url);
  if (!res.ok) throw new Error('Search failed');
  return res.json(); // [{id,title}]
}

const doSearch = debounce(async () => {
  try {
    const q = chatSearchInput.value.trim();
    chatSearchClear.classList.toggle('show', q.length > 0);

    const result = await fetchSearchResults(q);
    renderChatList(result);
  } catch (e) {
    console.error(e);
  }
}, 300);

// events
if (chatSearchInput) {
  chatSearchInput.addEventListener('input', doSearch);
  chatSearchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      chatSearchInput.value = '';
      doSearch();
      chatSearchInput.blur();
    }
  });
}
if (chatSearchClear) {
  chatSearchClear.addEventListener('click', () => {
    chatSearchInput.value = '';
    chatSearchInput.focus();
    doSearch();
  });
}

// Saat pertama load, tampilkan semua (query kosong)
doSearch();
</script>
</body>
</html>
